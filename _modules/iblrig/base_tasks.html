

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iblrig.base_tasks &mdash; iblrig 8.24.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_lesson.css?v=0c089442" />
      <link rel="stylesheet" type="text/css" href="../../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=43b36fd3"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/minipres.js?v=a0d29692"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            iblrig
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Using IBLRIG v8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware.html">Hardware Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference_developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/int-brain-lab/iblrig">IBLRIG on GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://doi.org/10.6084/m9.figshare.11634732">Appendix 3: IBL protocol for setting up the behavioral training rig</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">iblrig</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">iblrig.base_tasks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iblrig.base_tasks</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Commonalities for all tasks.</span>

<span class="sd">This module provides hardware mixins that can be used together with BaseSession to compose tasks.</span>
<span class="sd">This module tries to exclude task related logic.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">importlib.metadata</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">final</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">pythonosc</span> <span class="kn">import</span> <span class="n">udp_client</span>

<span class="kn">import</span> <span class="nn">ibllib.io.session_params</span> <span class="k">as</span> <span class="nn">ses_params</span>
<span class="kn">import</span> <span class="nn">iblrig.graphic</span> <span class="k">as</span> <span class="nn">graph</span>
<span class="kn">import</span> <span class="nn">iblrig.path_helper</span>
<span class="kn">import</span> <span class="nn">pybpodapi</span>
<span class="kn">from</span> <span class="nn">ibllib.oneibl.registration</span> <span class="kn">import</span> <span class="n">IBLRegistrationClient</span>
<span class="kn">from</span> <span class="nn">iblrig</span> <span class="kn">import</span> <span class="n">net</span><span class="p">,</span> <span class="n">path_helper</span><span class="p">,</span> <span class="n">sound</span>
<span class="kn">from</span> <span class="nn">iblrig.constants</span> <span class="kn">import</span> <span class="n">BASE_PATH</span><span class="p">,</span> <span class="n">BONSAI_EXE</span><span class="p">,</span> <span class="n">PYSPIN_AVAILABLE</span>
<span class="kn">from</span> <span class="nn">iblrig.frame2ttl</span> <span class="kn">import</span> <span class="n">Frame2TTL</span>
<span class="kn">from</span> <span class="nn">iblrig.hardware</span> <span class="kn">import</span> <span class="n">SOFTCODE</span><span class="p">,</span> <span class="n">Bpod</span><span class="p">,</span> <span class="n">RotaryEncoderModule</span><span class="p">,</span> <span class="n">sound_device_factory</span>
<span class="kn">from</span> <span class="nn">iblrig.hifi</span> <span class="kn">import</span> <span class="n">HiFi</span>
<span class="kn">from</span> <span class="nn">iblrig.path_helper</span> <span class="kn">import</span> <span class="n">load_pydantic_yaml</span>
<span class="kn">from</span> <span class="nn">iblrig.pydantic_definitions</span> <span class="kn">import</span> <span class="n">HardwareSettings</span><span class="p">,</span> <span class="n">RigSettings</span><span class="p">,</span> <span class="n">TrialDataModel</span>
<span class="kn">from</span> <span class="nn">iblrig.tools</span> <span class="kn">import</span> <span class="n">call_bonsai</span>
<span class="kn">from</span> <span class="nn">iblrig.transfer_experiments</span> <span class="kn">import</span> <span class="n">BehaviorCopier</span><span class="p">,</span> <span class="n">VideoCopier</span>
<span class="kn">from</span> <span class="nn">iblrig.valve</span> <span class="kn">import</span> <span class="n">Valve</span>
<span class="kn">from</span> <span class="nn">iblutil.io.net.base</span> <span class="kn">import</span> <span class="n">ExpMessage</span>
<span class="kn">from</span> <span class="nn">iblutil.spacer</span> <span class="kn">import</span> <span class="n">Spacer</span>
<span class="kn">from</span> <span class="nn">iblutil.util</span> <span class="kn">import</span> <span class="n">Bunch</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">setup_logger</span>
<span class="kn">from</span> <span class="nn">one.alf.io</span> <span class="kn">import</span> <span class="n">next_num_folder</span>
<span class="kn">from</span> <span class="nn">one.api</span> <span class="kn">import</span> <span class="n">ONE</span><span class="p">,</span> <span class="n">OneAlyx</span>
<span class="kn">from</span> <span class="nn">pybpodapi.protocol</span> <span class="kn">import</span> <span class="n">StateMachine</span>

<span class="n">OSC_CLIENT_IP</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="HasBpod">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.HasBpod.html#iblrig.base_tasks.HasBpod">[docs]</a>
<span class="k">class</span> <span class="nc">HasBpod</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="n">bpod</span><span class="p">:</span> <span class="n">Bpod</span></div>



<div class="viewcode-block" id="BaseSession">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession">[docs]</a>
<span class="k">class</span> <span class="nc">BaseSession</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;str: !!CURRENTLY UNUSED!! task version string.&quot;&quot;&quot;</span>
    <span class="c1"># protocol_name: str | None = None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;str: The name of the task protocol (NB: avoid spaces).&quot;&quot;&quot;</span>
    <span class="n">base_parameters_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Path: A YAML file containing base, default task parameters.&quot;&quot;&quot;</span>
    <span class="n">is_mock</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;list of str: One or more ibllib.pipes.tasks.Task names for task extraction.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;logging.Logger: Log instance used solely to keep track of log level passed to constructor.&quot;&quot;&quot;</span>
    <span class="n">experiment_description</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dict: The experiment description.&quot;&quot;&quot;</span>
    <span class="n">extractor_tasks</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;list of str: An optional list of pipeline task class names to instantiate when preprocessing task data.&quot;&quot;&quot;</span>

    <span class="n">TrialDataModel</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">TrialDataModel</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">protocol_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

<div class="viewcode-block" id="BaseSession.__init__">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">task_parameter_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">file_hardware_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hardware_settings</span><span class="p">:</span> <span class="n">HardwareSettings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_iblrig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">iblrig_settings</span><span class="p">:</span> <span class="n">RigSettings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">one</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">projects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">procedures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stub</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subject_weight_grams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">wizard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param subject: The subject nickname. Required.</span>
<span class="sd">        :param task_parameter_file: an optional path to the task_parameters.yaml file</span>
<span class="sd">        :param file_hardware_settings: name of the hardware file in the settings folder, or full file path</span>
<span class="sd">        :param hardware_settings: an optional dictionary of hardware settings. Keys will override any keys in the file</span>
<span class="sd">        :param file_iblrig_settings: name of the iblrig file in the settings folder, or full file path</span>
<span class="sd">        :param iblrig_settings: an optional dictionary of iblrig settings. Keys will override any keys in the file</span>
<span class="sd">        :param one: an optional instance of ONE</span>
<span class="sd">        :param interactive:</span>
<span class="sd">        :param projects: An optional list of Alyx protocols.</span>
<span class="sd">        :param procedures: An optional list of Alyx procedures.</span>
<span class="sd">        :param subject_weight_grams: weight of the subject</span>
<span class="sd">        :param stub: A full path to an experiment description file containing experiment information.</span>
<span class="sd">        :param append: bool, if True, append to the latest existing session of the same subject for the same day</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractor_tasks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;extractor_tasks&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_loggers</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EmptySession</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;iblrig version </span><span class="si">{</span><span class="n">iblrig</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pybpod version </span><span class="si">{</span><span class="n">pybpodapi</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Session protocol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="si">}</span><span class="s1"> &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="sa">f</span><span class="s2">&quot;version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">)&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;undefined version&quot;</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Session call: </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="n">interactive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_one</span> <span class="o">=</span> <span class="n">one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># loads in the settings: first load the files, then update with the input argument if provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">:</span> <span class="n">HardwareSettings</span> <span class="o">=</span> <span class="n">load_pydantic_yaml</span><span class="p">(</span><span class="n">HardwareSettings</span><span class="p">,</span> <span class="n">file_hardware_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hardware_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hardware_settings</span><span class="p">)</span>
            <span class="n">HardwareSettings</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">:</span> <span class="n">RigSettings</span> <span class="o">=</span> <span class="n">load_pydantic_yaml</span><span class="p">(</span><span class="n">RigSettings</span><span class="p">,</span> <span class="n">file_iblrig_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iblrig_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iblrig_settings</span><span class="p">)</span>
            <span class="n">RigSettings</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wizard</span> <span class="o">=</span> <span class="n">wizard</span>

        <span class="c1"># Load the tasks settings, from the task folder or override with the input argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_task_parameter_files</span><span class="p">(</span><span class="n">task_parameter_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;NTRIALS&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;NTRIALS_CORRECT&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;PROCEDURES&#39;</span><span class="p">:</span> <span class="n">procedures</span><span class="p">,</span>
                <span class="s1">&#39;PROJECTS&#39;</span><span class="p">:</span> <span class="n">projects</span><span class="p">,</span>
                <span class="s1">&#39;SESSION_START_TIME&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;SESSION_END_TIME&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;SESSION_NUMBER&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                <span class="s1">&#39;SUBJECT_WEIGHT&#39;</span><span class="p">:</span> <span class="n">subject_weight_grams</span><span class="p">,</span>
                <span class="s1">&#39;TOTAL_WATER_DELIVERED&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Executes mixins init methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_mixins_shared_function</span><span class="p">(</span><span class="s1">&#39;init_mixin&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_paths</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">EmptySession</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Session raw data: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Prepare the experiment description dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_experiment_description_dict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TASK_COLLECTION&#39;</span><span class="p">),</span>
            <span class="n">procedures</span><span class="p">,</span>
            <span class="n">projects</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">,</span>
            <span class="n">stub</span><span class="p">,</span>
            <span class="n">extractors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extractor_tasks</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BaseSession.get_task_file">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.get_task_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_task_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path to the task&#39;s python file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The path to the task file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span></div>


<div class="viewcode-block" id="BaseSession.get_task_directory">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.get_task_directory">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_task_directory</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the path to the task&#39;s directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The path to the task&#39;s directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_task_file</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span></div>


<div class="viewcode-block" id="BaseSession.read_task_parameter_files">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.read_task_parameter_files">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read_task_parameter_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task_parameter_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bunch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the task&#39;s parameters from the various YAML files in the hierarchy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task_parameter_file : str or Path, optional</span>
<span class="sd">            Path to override the task parameter file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Bunch</span>
<span class="sd">            Task parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the tasks settings, from the task folder or override with the input argument</span>
        <span class="n">base_parameters_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">task_parameter_file</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_task_directory</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;task_parameters.yaml&#39;</span><span class="p">)]</span>

        <span class="c1"># loop through the task hierarchy to gather parameter files</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="n">base_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;base_parameters_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_parameters_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_file</span><span class="p">)</span>

        <span class="c1"># remove list duplicates while preserving order, we want the highest order first</span>
        <span class="n">base_parameters_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">base_parameters_files</span><span class="p">))))</span>

        <span class="c1"># loop through files and update the dictionary, the latest files in the hierarchy have precedence</span>
        <span class="n">task_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param_file</span> <span class="ow">in</span> <span class="n">base_parameters_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">task_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># at last sort the dictionary so it≈õ easier for a human to navigate the many keys, return as a Bunch</span>
        <span class="k">return</span> <span class="n">Bunch</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">task_params</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span></div>


    <span class="k">def</span> <span class="nf">_init_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bunch</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize session paths.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        append : bool</span>
<span class="sd">            Iterate task collection within today&#39;s most recent session folder for the selected subject, instead of</span>
<span class="sd">            iterating session number.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Bunch</span>
<span class="sd">            Bunch with keys:</span>

<span class="sd">            *   BONSAI: full path to the bonsai executable</span>
<span class="sd">                `C:\iblrigv8\Bonsai\Bonsai.exe`</span>
<span class="sd">            *   VISUAL_STIM_FOLDER: full path to the visual stimulus folder</span>
<span class="sd">                `C:\iblrigv8\visual_stim`</span>
<span class="sd">            *   LOCAL_SUBJECT_FOLDER: full path to the local subject folder</span>
<span class="sd">                `C:\iblrigv8_data\mainenlab\Subjects`</span>
<span class="sd">            *   REMOTE_SUBJECT_FOLDER: full path to the remote subject folder</span>
<span class="sd">                `Y:\Subjects`</span>
<span class="sd">            *   SESSION_FOLDER: full path to the current session:</span>
<span class="sd">                `C:\iblrigv8_data\mainenlab\Subjects\SWC_043\2019-01-01\001`</span>
<span class="sd">            *   TASK_COLLECTION: folder name of the current task</span>
<span class="sd">                `raw_task_data_00`</span>
<span class="sd">            *   SESSION_RAW_DATA_FOLDER: concatenation of the session folder and the task collection.</span>
<span class="sd">                This is where the task data gets written</span>
<span class="sd">                `C:\iblrigv8_data\mainenlab\Subjects\SWC_043\2019-01-01\001\raw_task_data_00`</span>
<span class="sd">            *   DATA_FILE_PATH: contains the bpod trials</span>
<span class="sd">                `C:\iblrigv8_data\mainenlab\Subjects\SWC_043\2019-01-01\001\raw_task_data_00\_iblrig_taskData.raw.jsonable`</span>
<span class="sd">            *   SETTINGS_FILE_PATH: contains the task settings</span>
<span class="sd">                `C:\iblrigv8_data\mainenlab\Subjects\SWC_043\2019-01-01\001\raw_task_data_00\_iblrig_taskSettings.raw.json`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rig_computer_paths</span> <span class="o">=</span> <span class="n">path_helper</span><span class="o">.</span><span class="n">get_local_and_remote_paths</span><span class="p">(</span>
            <span class="n">local_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">iblrig_local_data_path</span><span class="p">,</span>
            <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">iblrig_remote_data_path</span><span class="p">,</span>
            <span class="n">lab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_LAB</span><span class="p">,</span>
            <span class="n">iblrig_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;IBLRIG_FOLDER&#39;</span><span class="p">:</span> <span class="n">BASE_PATH</span><span class="p">})</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">BONSAI</span> <span class="o">=</span> <span class="n">BONSAI_EXE</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">VISUAL_STIM_FOLDER</span> <span class="o">=</span> <span class="n">BASE_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;visual_stim&#39;</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">LOCAL_SUBJECT_FOLDER</span> <span class="o">=</span> <span class="n">rig_computer_paths</span><span class="p">[</span><span class="s1">&#39;local_subjects_folder&#39;</span><span class="p">]</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">REMOTE_SUBJECT_FOLDER</span> <span class="o">=</span> <span class="n">rig_computer_paths</span><span class="p">[</span><span class="s1">&#39;remote_subjects_folder&#39;</span><span class="p">]</span>
        <span class="c1"># initialize the session path</span>
        <span class="n">date_folder</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">LOCAL_SUBJECT_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SESSION_START_TIME</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="c1"># this is the case where we append a new protocol to an existing session</span>
            <span class="n">todays_sessions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">,</span> <span class="n">date_folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">todays_sessions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Trying to chain a protocol, but no session folder found in </span><span class="si">{</span><span class="n">date_folder</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span> <span class="o">=</span> <span class="n">todays_sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">path_helper</span><span class="o">.</span><span class="n">iterate_collection</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIN_SYNC&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Chained protocols make little sense when Bpod is the main sync as there is no</span>
<span class="sd">                continuous acquisition between protocols.  Only one sync collection can be defined in</span>
<span class="sd">                the experiment description file.</span>
<span class="sd">                If you are running experiments with an ephys rig (nidq) or an external daq, you should</span>
<span class="sd">                correct the MAIN_SYNC parameter in the hardware settings file in ./settings/hardware_settings.yaml</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Chained protocols not supported for bpod-only sessions&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># in this case the session path is created from scratch</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span> <span class="o">=</span> <span class="n">date_folder</span> <span class="o">/</span> <span class="n">next_num_folder</span><span class="p">(</span><span class="n">date_folder</span><span class="p">)</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">path_helper</span><span class="o">.</span><span class="n">iterate_collection</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SESSION_NUMBER</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">DATA_FILE_PATH</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskData.raw.jsonable&#39;</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">SETTINGS_FILE_PATH</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskSettings.raw.json&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exp_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct an experiment reference string from the session info attribute.&quot;&quot;&quot;</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;SESSION_START_TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;SESSION_NUMBER&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">number</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dict2ref</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">sequence</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_setup_loggers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="n">level_bpod</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="s1">&#39;iblrig&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># logger attr used by create_session to determine log level</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="s1">&#39;pybpodapi&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level_bpod</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_remove_file_loggers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">logger_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;iblrig&#39;</span><span class="p">,</span> <span class="s1">&#39;pybpodapi&#39;</span><span class="p">]:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
            <span class="n">file_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">fh</span> <span class="k">for</span> <span class="n">fh</span> <span class="ow">in</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">fh</span> <span class="ow">in</span> <span class="n">file_handlers</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

<div class="viewcode-block" id="BaseSession.make_experiment_description_dict">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.make_experiment_description_dict">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_experiment_description_dict</span><span class="p">(</span>
        <span class="n">task_protocol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task_collection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">procedures</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">projects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hardware_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">HardwareSettings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stub</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extractors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">camera_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct an experiment description dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task_protocol : str</span>
<span class="sd">            The task protocol name, e.g. _ibl_trainingChoiceWorld2.0.0.</span>
<span class="sd">        task_collection : str</span>
<span class="sd">            The task collection name, e.g. raw_task_data_00.</span>
<span class="sd">        procedures : list</span>
<span class="sd">            An optional list of Alyx procedures.</span>
<span class="sd">        projects : list</span>
<span class="sd">            An optional list of Alyx protocols.</span>
<span class="sd">        hardware_settings : dict</span>
<span class="sd">            An optional dict of hardware devices, loaded from the hardware_settings.yaml file.</span>
<span class="sd">        stub : dict</span>
<span class="sd">            An optional experiment description stub to update.</span>
<span class="sd">        extractors: list</span>
<span class="sd">            An optional list of extractor names for the task.</span>
<span class="sd">        camera_config : str</span>
<span class="sd">            The camera configuration name in the hardware settings. Defaults to the first key in</span>
<span class="sd">            &#39;device_cameras&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The experiment description.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">ses_params</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">stub</span><span class="p">)</span> <span class="k">if</span> <span class="n">stub</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="c1"># Add hardware devices</span>
        <span class="k">if</span> <span class="n">hardware_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hardware_settings</span><span class="p">,</span> <span class="n">HardwareSettings</span><span class="p">):</span>
                <span class="n">hardware_settings</span> <span class="o">=</span> <span class="n">hardware_settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cams</span> <span class="o">=</span> <span class="n">hardware_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_cameras&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cams</span><span class="p">:</span>
                <span class="n">devices</span><span class="p">[</span><span class="s1">&#39;cameras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">camera_config</span> <span class="o">=</span> <span class="n">camera_config</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cams</span><span class="p">),</span> <span class="p">{})</span>
                <span class="n">devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">VideoCopier</span><span class="o">.</span><span class="n">config2stub</span><span class="p">(</span><span class="n">cams</span><span class="p">[</span><span class="n">camera_config</span><span class="p">])[</span><span class="s1">&#39;devices&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">hardware_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device_microphone&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">devices</span><span class="p">[</span><span class="s1">&#39;microphone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;microphone&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">task_collection</span><span class="p">,</span> <span class="s1">&#39;sync_label&#39;</span><span class="p">:</span> <span class="s1">&#39;audio&#39;</span><span class="p">}}</span>
            <span class="n">ses_params</span><span class="o">.</span><span class="n">merge_params</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="n">devices</span><span class="p">})</span>

        <span class="c1"># Add projects and procedures</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;procedures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;procedures&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="n">procedures</span> <span class="ow">or</span> <span class="p">[])))</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;projects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;projects&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="n">projects</span> <span class="ow">or</span> <span class="p">[])))</span>
        <span class="n">is_main_sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">hardware_settings</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIN_SYNC&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Add sync key if required</span>
        <span class="k">if</span> <span class="n">is_main_sync</span> <span class="ow">and</span> <span class="s1">&#39;sync&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sync&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bpod&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">task_collection</span><span class="p">,</span> <span class="s1">&#39;acquisition_software&#39;</span><span class="p">:</span> <span class="s1">&#39;pybpod&#39;</span><span class="p">,</span> <span class="s1">&#39;extension&#39;</span><span class="p">:</span> <span class="s1">&#39;.jsonable&#39;</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="c1"># Add task</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span><span class="n">task_protocol</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">task_collection</span><span class="p">}}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_main_sync</span><span class="p">:</span>
            <span class="n">task</span><span class="p">[</span><span class="n">task_protocol</span><span class="p">][</span><span class="s1">&#39;sync_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bpod&#39;</span>
        <span class="k">if</span> <span class="n">extractors</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extractors</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;extractors parameter must be a list of strings&#39;</span>
            <span class="n">task</span><span class="p">[</span><span class="n">task_protocol</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;extractors&#39;</span><span class="p">:</span> <span class="n">extractors</span><span class="p">})</span>
        <span class="k">if</span> <span class="s1">&#39;tasks&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">description</span></div>


    <span class="k">def</span> <span class="nf">_make_task_parameters_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create dictionary that will be saved to the settings json file for extraction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary that will be saved to the settings json file for extraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="p">)</span>  <span class="c1"># Grab parameters from task_params session</span>
        <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>  <span class="c1"># Update dict with hardware settings from session</span>
        <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">))</span>  <span class="c1"># Update dict with session_info (subject, procedure, projects)</span>
        <span class="n">patch_dict</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Various values added to ease transition from iblrig v7 to v8, different home may be desired</span>
            <span class="s1">&#39;IBLRIG_VERSION&#39;</span><span class="p">:</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
            <span class="s1">&#39;PYBPOD_PROTOCOL&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span><span class="p">,</span>
            <span class="s1">&#39;ALYX_USER&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_USER</span><span class="p">,</span>
            <span class="s1">&#39;ALYX_LAB&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_LAB</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">):</span>
            <span class="n">patch_dict</span><span class="p">[</span><span class="s1">&#39;PROJECT_EXTRACTION_VERSION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s1">&#39;project_extraction&#39;</span><span class="p">)</span>
        <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">patch_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dict</span>

<div class="viewcode-block" id="BaseSession.save_task_parameters_to_json_file">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.save_task_parameters_to_json_file">[docs]</a>
    <span class="k">def</span> <span class="nf">save_task_parameters_to_json_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination_folder</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collects the various settings and parameters of the session and outputs them to a JSON file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            Path to the resultant JSON file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_task_parameters_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">destination_folder</span><span class="p">:</span>
            <span class="n">json_file</span> <span class="o">=</span> <span class="n">destination_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskSettings.raw.json&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;SETTINGS_FILE_PATH&#39;</span><span class="p">]</span>
        <span class="n">json_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output_dict</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>  <span class="c1"># converts datetime objects to string</span>
        <span class="k">return</span> <span class="n">json_file</span>  <span class="c1"># PosixPath</span></div>


<div class="viewcode-block" id="BaseSession.save_trial_data_to_json">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.save_trial_data_to_json">[docs]</a>
    <span class="nd">@final</span>
    <span class="k">def</span> <span class="nf">save_trial_data_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bpod_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and save trial data.</span>

<span class="sd">        This method retrieve&#39;s the current trial&#39;s data from the trial_table and validates it using a Pydantic model</span>
<span class="sd">        (self.TrialDataDefinition). In merges in the trial&#39;s bpod_data dict and appends everything to the session&#39;s</span>
<span class="sd">        JSON data file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bpod_data : dict</span>
<span class="sd">            Trial data returned from pybpod.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get trial&#39;s data as a dict</span>
        <span class="n">trial_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trials_table</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># warn about entries not covered by pydantic model</span>
        <span class="k">if</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trial_num&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">trial_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TrialDataModel</span><span class="o">.</span><span class="n">model_fields</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">}:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Key &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; in trial_data is missing from TrialDataModel - &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;its value (</span><span class="si">{</span><span class="n">trial_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s1">) will not be validated.&#39;</span>
                <span class="p">)</span>

        <span class="c1"># validate by passing through pydantic model</span>
        <span class="n">trial_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrialDataModel</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

        <span class="c1"># add bpod_data as &#39;behavior_data&#39;</span>
        <span class="n">trial_data</span><span class="p">[</span><span class="s1">&#39;behavior_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpod_data</span>

        <span class="c1"># write json data to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;DATA_FILE_PATH&#39;</span><span class="p">],</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ONE getter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_URL&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">info_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;alyx client with user name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_USER&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;and url: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_URL&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_one</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span>
                    <span class="n">base_url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_URL&#39;</span><span class="p">]),</span>
                    <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_USER&#39;</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span>
                    <span class="n">cache_rest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;instantiated &#39;</span> <span class="o">+</span> <span class="n">info_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;could not connect to &#39;</span> <span class="o">+</span> <span class="n">info_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one</span>

<div class="viewcode-block" id="BaseSession.register_to_alyx">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.register_to_alyx">[docs]</a>
    <span class="k">def</span> <span class="nf">register_to_alyx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers the session to Alyx.</span>

<span class="sd">        This registers the session using the IBLRegistrationClient class.  This uses the settings</span>
<span class="sd">        file(s) and experiment description file to extract the session data.  This may be called</span>
<span class="sd">        any number of times and if the session record already exists in Alyx it will be updated.</span>
<span class="sd">        If session registration fails, it will be done before extraction in the ibllib pipeline.</span>

<span class="sd">        Note that currently the subject weight is registered once and only once.  The recorded</span>
<span class="sd">        weight of the first protocol run is used.</span>

<span class="sd">        Water administrations are added separately by this method: it is expected that</span>
<span class="sd">        `register_session` is first called with no recorded total water. This method will then add</span>
<span class="sd">        a water administration each time it is called, and should therefore be called only once</span>
<span class="sd">        after each protocol is run. If water administration registration fails for all protocols,</span>
<span class="sd">        this will be done before extraction in the ibllib pipline, however, if a water</span>
<span class="sd">        administration is successfully registered for one protocol and subsequent ones fail to</span>
<span class="sd">        register, these will not be added before extraction in ibllib and therefore must be</span>
<span class="sd">        manually added to Alyx.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The registered session record.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :external+iblenv:meth:`ibllib.oneibl.registration.IBLRegistrationClient.register_session` - The registration method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;iblrig_test_subject&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;test_subject&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Not registering test subject to Alyx&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">offline</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">IBLRegistrationClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
            <span class="n">ses</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="p">,</span> <span class="n">register_reward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not register session to Alyx&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># add the water administration if there was water administered</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;TOTAL_WATER_DELIVERED&#39;</span><span class="p">]:</span>
                <span class="n">wa</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_water_administration</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_NAME</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;TOTAL_WATER_DELIVERED&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="n">session</span><span class="o">=</span><span class="n">ses</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">36</span><span class="p">:],</span>
                    <span class="n">water_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REWARD_TYPE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Water administered registered in Alyx database: </span><span class="si">{</span><span class="n">ses</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wa</span><span class="p">[</span><span class="s1">&#39;water_administered&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">mL&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not register water administration to Alyx&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">ses</span></div>


    <span class="k">def</span> <span class="nf">_execute_mixins_shared_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over all methods of the class that start with pattern and execute them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pattern : str</span>
<span class="sd">            &#39;init_mixin&#39;, &#39;start_mixin&#39;, &#39;stop_mixin&#39;, or &#39;cleanup_mixin&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pattern</span><span class="p">)]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">method_names</span> <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="n">meth</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_datetime</span>

<div class="viewcode-block" id="BaseSession.mock">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.mock">[docs]</a>
    <span class="k">def</span> <span class="nf">mock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_mock</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseSession.create_session">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.create_session">[docs]</a>
    <span class="k">def</span> <span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the session path and save json parameters in the task collection folder.</span>

<span class="sd">        This will also create the protocol folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;TASK_PARAMETERS_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_task_parameters_to_json_file</span><span class="p">()</span>
        <span class="c1"># enable file logging</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_ibl_log.info-acquisition.log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_loggers</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="c1"># copy the acquisition stub to the remote session folder</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">BehaviorCopier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="p">,</span> <span class="n">remote_subjects_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;REMOTE_SUBJECT_FOLDER&#39;</span><span class="p">])</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">initialize_experiment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_description</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_to_alyx</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseSession.run">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Common pre-run instructions for all tasks.</span>

<span class="sd">        Defines sigint handler for a graceful exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># here we make sure we connect to the hardware before writing the session to disk</span>
        <span class="c1"># this prevents from incrementing endlessly the session number if the hardware fails to connect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_hardware</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_session</span><span class="p">()</span>
        <span class="c1"># When not running the first chained protocol, we can skip the weighing dialog</span>
        <span class="n">first_protocol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_WEIGHT</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="n">first_protocol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_WEIGHT</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">numinput</span><span class="p">(</span>
                <span class="s1">&#39;Subject weighing (gr)&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_NAME</span><span class="si">}</span><span class="s1"> weight (gr):&#39;</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">sigint_handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># create a signal handler for a graceful exit: create a stop flag in the session folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;SIGINT signal detected, will exit at the end of the trial&#39;</span><span class="p">)</span>

        <span class="c1"># if upon starting there is a flag just remove it, this is to prevent killing a session in the egg</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>  <span class="c1"># runs the specific task logic i.e. trial loop etc...</span>
        <span class="c1"># post task instructions</span>
        <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Graceful exit&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Session </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SESSION_END_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wizard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">POOP_COUNT</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">numinput</span><span class="p">(</span>
                <span class="s1">&#39;Poop count&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_NAME</span><span class="si">}</span><span class="s1"> droppings count:&#39;</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">askint</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_task_parameters_to_json_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_to_alyx</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_mixins_shared_function</span><span class="p">(</span><span class="s1">&#39;stop_mixin&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_mixins_shared_function</span><span class="p">(</span><span class="s1">&#39;cleanup_mixin&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseSession.start_hardware">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.start_hardware">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">start_hardware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the hardware.</span>

<span class="sd">        This method doesn&#39;t explicitly start the mixins as the order has to be defined in the child classes.</span>
<span class="sd">        This needs to be implemented in the child classes, and should start and connect to all hardware pieces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span></div>


    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span>

<div class="viewcode-block" id="BaseSession.extra_parser">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BaseSession.html#iblrig.base_tasks.BaseSession.extra_parser">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extra_parser</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specify extra kwargs arguments to expose to the user prior running the task.</span>

<span class="sd">        Make sure you instantiate the parser.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        argparse.ArgumentParser</span>
<span class="sd">            The extra parser instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>
</div>



<span class="c1"># this class gets called to get the path constructor utility to predict the session path</span>
<div class="viewcode-block" id="EmptySession">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.EmptySession.html#iblrig.base_tasks.EmptySession">[docs]</a>
<span class="k">class</span> <span class="nc">EmptySession</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
    <span class="n">protocol_name</span> <span class="o">=</span> <span class="s1">&#39;empty&#39;</span>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="EmptySession.start_hardware">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.EmptySession.html#iblrig.base_tasks.EmptySession.start_hardware">[docs]</a>
    <span class="k">def</span> <span class="nf">start_hardware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="OSCClient">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.OSCClient.html#iblrig.base_tasks.OSCClient">[docs]</a>
<span class="k">class</span> <span class="nc">OSCClient</span><span class="p">(</span><span class="n">udp_client</span><span class="o">.</span><span class="n">SimpleUDPClient</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles communication to Bonsai using a UDP Client</span>
<span class="sd">    OSC channels:</span>
<span class="sd">        USED:</span>
<span class="sd">        /t  -&gt; (int)    trial number current</span>
<span class="sd">        /p  -&gt; (int)    position of stimulus init for current trial</span>
<span class="sd">        /h  -&gt; (float)  phase of gabor for current trial</span>
<span class="sd">        /c  -&gt; (float)  contrast of stimulus for current trial</span>
<span class="sd">        /f  -&gt; (float)  frequency of gabor patch for current trial</span>
<span class="sd">        /a  -&gt; (float)  angle of gabor patch for current trial</span>
<span class="sd">        /g  -&gt; (float)  gain of RE to visual stim displacement</span>
<span class="sd">        /s  -&gt; (float)  sigma of the 2D gaussian of gabor</span>
<span class="sd">        /e  -&gt; (int)    events transitions  USED BY SOFTCODE HANDLER FUNC</span>
<span class="sd">        /r  -&gt; (int)    whether to reverse the side contingencies (0, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">OSC_PROTOCOL</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;trial_num&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/t&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/p&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;stim_phase&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/h&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;contrast&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/c&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;stim_freq&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/f&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;stim_angle&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/a&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;stim_gain&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/g&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="s1">&#39;stim_sigma&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mess</span><span class="o">=</span><span class="s1">&#39;/s&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="c1"># &#39;stim_reverse&#39;: dict(mess=&#39;/r&#39;, type=int),  # this is not handled by Bonsai</span>
    <span class="p">}</span>

<div class="viewcode-block" id="OSCClient.__init__">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.OSCClient.html#iblrig.base_tasks.OSCClient.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="OSCClient.send2bonsai">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.OSCClient.html#iblrig.base_tasks.OSCClient.send2bonsai">[docs]</a>
    <span class="k">def</span> <span class="nf">send2bonsai</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param see list of keys in OSC_PROTOCOL</span>
<span class="sd">        :example: client.send2bonsai(trial_num=6, sim_freq=50)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OSC_PROTOCOL</span><span class="p">:</span>
                <span class="c1"># need to convert basic numpy types to low-level python types for</span>
                <span class="c1"># punch card generation OSC module, I might as well have written C code</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OSC_PROTOCOL</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;mess&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">OSC_PROTOCOL</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">](</span><span class="n">value</span><span class="p">))</span></div>


<div class="viewcode-block" id="OSCClient.exit">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.OSCClient.html#iblrig.base_tasks.OSCClient.exit">[docs]</a>
    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="s1">&#39;/x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BonsaiRecordingMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin">[docs]</a>
<span class="k">class</span> <span class="nc">BonsaiRecordingMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>

<div class="viewcode-block" id="BonsaiRecordingMixin.init_mixin_bonsai_recordings">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin.init_mixin_bonsai_recordings">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_bonsai_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_camera</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;udp_client&#39;</span><span class="p">:</span> <span class="n">OSCClient</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">7111</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_microphone</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;udp_client&#39;</span><span class="p">:</span> <span class="n">OSCClient</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">7112</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the name of the configuration to run</span></div>


<div class="viewcode-block" id="BonsaiRecordingMixin.stop_mixin_bonsai_recordings">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin.stop_mixin_bonsai_recordings">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_mixin_bonsai_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopping Bonsai recordings&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_camera</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_microphone</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>


<div class="viewcode-block" id="BonsaiRecordingMixin.start_mixin_bonsai_microphone">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin.start_mixin_bonsai_microphone">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_bonsai_microphone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># Use the first key in the device_cameras map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_cameras</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># The camera workflow on the behaviour computer already contains the microphone recording</span>
        <span class="c1"># so the device camera workflow and the microphone one are exclusive</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Camera workflow defined; so no need to separately start microphone.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">RECORD_SOUND</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Sound should not be recorded</span>
        <span class="n">workflow_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">IBLRIG_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_microphone</span><span class="p">[</span><span class="s1">&#39;BONSAI_WORKFLOW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;FileNameMic&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_micData.raw.wav&#39;</span><span class="p">),</span>
            <span class="s1">&#39;RecordSound&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">RECORD_SOUND</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">call_bonsai</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bonsai microphone recording module loaded: OK&#39;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_camera_mixin_bonsai_get_workflow_file</span><span class="p">(</span><span class="n">cameras</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the bonsai workflow file for the cameras from the hardware_settings.yaml file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cameras : dict</span>
<span class="sd">            The hardware settings configuration.</span>
<span class="sd">        name : {&#39;setup&#39;, &#39;recording&#39;} str</span>
<span class="sd">            The workflow type.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The workflow path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cameras</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cameras</span><span class="p">[</span><span class="s1">&#39;BONSAI_WORKFLOW&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="BonsaiRecordingMixin.start_mixin_bonsai_cameras">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin.start_mixin_bonsai_cameras">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_bonsai_cameras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the cameras.</span>

<span class="sd">        Starts the pipeline that aligns the camera focus with the desired borders of rig features.</span>
<span class="sd">        The actual triggering of the cameras is done in the trigger_bonsai_cameras method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># Use the first key in the device_cameras map</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_cameras</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_cameras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">workflow_file</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_mixin_bonsai_get_workflow_file</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s1">&#39;setup&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># enable trigger of cameras (so Bonsai can disable it again ... sigh)</span>
        <span class="k">if</span> <span class="n">PYSPIN_AVAILABLE</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">iblrig.video_pyspin</span> <span class="kn">import</span> <span class="n">enable_camera_trigger</span>

            <span class="n">enable_camera_trigger</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">call_bonsai</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># TODO Parameterize using configuration cameras</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bonsai cameras setup module loaded: OK&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BonsaiRecordingMixin.trigger_bonsai_cameras">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiRecordingMixin.html#iblrig.base_tasks.BonsaiRecordingMixin.trigger_bonsai_cameras">[docs]</a>
    <span class="k">def</span> <span class="nf">trigger_bonsai_cameras</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="c1"># Use the first key in the device_cameras map</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_cameras</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="n">configuration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_cameras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">{</span><span class="s1">&#39;BONSAI_WORKFLOW&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">workflow_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_mixin_bonsai_get_workflow_file</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s1">&#39;recording&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workflow_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">iblrig</span><span class="o">.</span><span class="n">path_helper</span><span class="o">.</span><span class="n">create_bonsai_layout_from_template</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">)</span>
        <span class="c1"># FIXME Use parameters in configuration map</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;FileNameLeft&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;raw_video_data&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_leftCamera.raw.avi&#39;</span><span class="p">),</span>
            <span class="s1">&#39;FileNameLeftData&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;raw_video_data&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_leftCamera.frameData.bin&#39;</span><span class="p">),</span>
            <span class="s1">&#39;FileNameMic&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_micData.raw.wav&#39;</span><span class="p">),</span>
            <span class="s1">&#39;RecordSound&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">RECORD_SOUND</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">call_bonsai</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bonsai camera recording process started&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BonsaiVisualStimulusMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin">[docs]</a>
<span class="k">class</span> <span class="nc">BonsaiVisualStimulusMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
<div class="viewcode-block" id="BonsaiVisualStimulusMixin.init_mixin_bonsai_visual_stimulus">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.init_mixin_bonsai_visual_stimulus">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_bonsai_visual_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># camera 7111, microphone 7112</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_visual_udp_client</span> <span class="o">=</span> <span class="n">OSCClient</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">7110</span><span class="p">)</span></div>


<div class="viewcode-block" id="BonsaiVisualStimulusMixin.start_mixin_bonsai_visual_stimulus">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.start_mixin_bonsai_visual_stimulus">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_bonsai_visual_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">choice_world_visual_stimulus</span><span class="p">()</span></div>


<div class="viewcode-block" id="BonsaiVisualStimulusMixin.stop_mixin_bonsai_visual_stimulus">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.stop_mixin_bonsai_visual_stimulus">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_mixin_bonsai_visual_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopping Bonsai visual stimulus&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_visual_udp_client</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>


<div class="viewcode-block" id="BonsaiVisualStimulusMixin.send_trial_info_to_bonsai">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.send_trial_info_to_bonsai">[docs]</a>
    <span class="k">def</span> <span class="nf">send_trial_info_to_bonsai</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send the trial information to Bonsai via UDP.</span>

<span class="sd">        The OSC protocol is documented in iblrig.base_tasks.BonsaiVisualStimulusMixin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bonsai_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trials_table</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_num</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_visual_udp_client</span><span class="o">.</span><span class="n">OSC_PROTOCOL</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trials_table</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">}</span>

        <span class="c1"># reverse wheel contingency: if stim_reverse is True we invert stim_gain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trials_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stim_reverse&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_num</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">bonsai_dict</span><span class="p">[</span><span class="s1">&#39;stim_gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">bonsai_dict</span><span class="p">[</span><span class="s1">&#39;stim_gain&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bonsai_visual_udp_client</span><span class="o">.</span><span class="n">send2bonsai</span><span class="p">(</span><span class="o">**</span><span class="n">bonsai_dict</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">bonsai_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="BonsaiVisualStimulusMixin.run_passive_visual_stim">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.run_passive_visual_stim">[docs]</a>
    <span class="k">def</span> <span class="nf">run_passive_visual_stim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_time</span><span class="o">=</span><span class="s1">&#39;00:05:00&#39;</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sa_time</span><span class="o">=</span><span class="s1">&#39;00:05:00&#39;</span><span class="p">):</span>
        <span class="n">workflow_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">VISUAL_STIM_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;passiveChoiceWorld&#39;</span><span class="p">,</span> <span class="s1">&#39;passiveChoiceWorld_passive.bonsai&#39;</span><span class="p">)</span>
        <span class="n">file_output_rfm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_RFMapStim.raw.bin&#39;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Stim.DisplayIndex&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_screen</span><span class="p">[</span><span class="s1">&#39;DISPLAY_IDX&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Stim.SpontaneousActivity0.DueTime&#39;</span><span class="p">:</span> <span class="n">sa_time</span><span class="p">,</span>
            <span class="s1">&#39;Stim.ReceptiveFieldMappingStim.FileNameRFMapStim&#39;</span><span class="p">:</span> <span class="n">file_output_rfm</span><span class="p">,</span>
            <span class="s1">&#39;Stim.ReceptiveFieldMappingStim.MappingTime&#39;</span><span class="p">:</span> <span class="n">map_time</span><span class="p">,</span>
            <span class="s1">&#39;Stim.ReceptiveFieldMappingStim.Rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">map_seconds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">map_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="n">sa_seconds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">sa_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting spontaneous activity (</span><span class="si">{</span><span class="n">sa_seconds</span><span class="si">}</span><span class="s1"> s) and RF mapping stims (</span><span class="si">{</span><span class="n">map_seconds</span><span class="si">}</span><span class="s1"> s)&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">call_bonsai</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Spontaneous activity and RF mapping stims finished&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="BonsaiVisualStimulusMixin.choice_world_visual_stimulus">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BonsaiVisualStimulusMixin.html#iblrig.base_tasks.BonsaiVisualStimulusMixin.choice_world_visual_stimulus">[docs]</a>
    <span class="k">def</span> <span class="nf">choice_world_visual_stimulus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">VISUAL_STIMULUS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">workflow_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">VISUAL_STIM_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">VISUAL_STIMULUS</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Stim.DisplayIndex&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_screen</span><span class="p">[</span><span class="s1">&#39;DISPLAY_IDX&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Stim.FileNameStimPositionScreen&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_stimPositionScreen.raw.csv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Stim.FileNameSyncSquareUpdate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_syncSquareUpdate.raw.csv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Stim.FileNamePositions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_encoderPositions.raw.ssv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Stim.FileNameEvents&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_encoderEvents.raw.ssv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Stim.FileNameTrialInfo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_encoderTrialInfo.raw.ssv&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Stim.REPortName&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="p">[</span><span class="s1">&#39;COM_ROTARY_ENCODER&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Stim.sync_x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">SYNC_SQUARE_X</span><span class="p">,</span>
            <span class="s1">&#39;Stim.sync_y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">SYNC_SQUARE_Y</span><span class="p">,</span>
            <span class="s1">&#39;Stim.TranslationZ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">STIM_TRANSLATION_Z</span><span class="p">,</span>  <span class="c1"># MINUS!!</span>
        <span class="p">}</span>
        <span class="n">call_bonsai</span><span class="p">(</span><span class="n">workflow_file</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">BONSAI_EDITOR</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Giving Bonsai some extra time to start ...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bonsai visual stimulus module loaded: OK&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BpodMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin">[docs]</a>
<span class="k">class</span> <span class="nc">BpodMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_raise_on_undefined_softcode_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">byte</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No handler defined for softcode #</span><span class="si">{</span><span class="n">byte</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BpodMixin.softcode_dictionary">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin.softcode_dictionary">[docs]</a>
    <span class="k">def</span> <span class="nf">softcode_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a softcode handler dict where each key corresponds to the softcode and each value to the</span>
<span class="sd">        function to be called.</span>

<span class="sd">        This needs to be wrapped this way because</span>
<span class="sd">            1) we want to be able to inherit this and dynamically add softcode to the dictionry</span>
<span class="sd">            2) we need to provide the Task object (self) at run time to have the functions with static args</span>
<span class="sd">        This is tricky as it is unclear if the task object is a copy or a reference when passed here.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OrderedDict[int, Callable]</span>
<span class="sd">            Softcode dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">softcode_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">SOFTCODE</span><span class="o">.</span><span class="n">STOP_SOUND</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                <span class="n">SOFTCODE</span><span class="o">.</span><span class="n">PLAY_TONE</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;GO_TONE&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">]),</span>
                <span class="n">SOFTCODE</span><span class="o">.</span><span class="n">PLAY_NOISE</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;WHITE_NOISE&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">]),</span>
                <span class="n">SOFTCODE</span><span class="o">.</span><span class="n">TRIGGER_CAMERA</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;trigger_bonsai_cameras&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_on_undefined_softcode_handler</span><span class="p">(</span><span class="n">SOFTCODE</span><span class="o">.</span><span class="n">TRIGGER_CAMERA</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">softcode_dict</span></div>


<div class="viewcode-block" id="BpodMixin.init_mixin_bpod">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin.init_mixin_bpod">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_bpod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">()</span></div>


<div class="viewcode-block" id="BpodMixin.stop_mixin_bpod">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin.stop_mixin_bpod">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_mixin_bpod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="BpodMixin.start_mixin_bpod">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin.start_mixin_bpod">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_bpod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The value for device_bpod:COM_BPOD in &#39;</span>
                <span class="s1">&#39;settings/hardware_settings.yaml is null. Please &#39;</span>
                <span class="s1">&#39;provide a valid port name.&#39;</span>
            <span class="p">)</span>
        <span class="n">disabled_ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;DISABLE_BEHAVIOR_INPUT_PORTS&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">],</span> <span class="n">disable_behavior_ports</span><span class="o">=</span><span class="n">disabled_ports</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">define_rotary_encoder_actions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">set_status_led</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">is_connected</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bpod hardware module loaded: OK&#39;</span><span class="p">)</span>
        <span class="c1"># make the bpod send spacer signals to the main sync clock for protocol discovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_spacers</span><span class="p">()</span></div>


<div class="viewcode-block" id="BpodMixin.send_spacers">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.BpodMixin.html#iblrig.base_tasks.BpodMixin.send_spacers">[docs]</a>
    <span class="k">def</span> <span class="nf">send_spacers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting task by sending a spacer signal on BNC1&#39;</span><span class="p">)</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="p">)</span>
        <span class="n">Spacer</span><span class="p">()</span><span class="o">.</span><span class="n">add_spacer_states</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">next_state</span><span class="o">=</span><span class="s1">&#39;exit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">send_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">run_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>  <span class="c1"># Locks until state machine &#39;exit&#39; is reached</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">current_trial</span><span class="o">.</span><span class="n">export</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Frame2TTLMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.Frame2TTLMixin.html#iblrig.base_tasks.Frame2TTLMixin">[docs]</a>
<span class="k">class</span> <span class="nc">Frame2TTLMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Frame 2 TTL interface for state machine.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Frame2TTLMixin.init_mixin_frame2ttl">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.Frame2TTLMixin.html#iblrig.base_tasks.Frame2TTLMixin.init_mixin_frame2ttl">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_frame2ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Frame2TTLMixin.start_mixin_frame2ttl">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.Frame2TTLMixin.html#iblrig.base_tasks.Frame2TTLMixin.start_mixin_frame2ttl">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_frame2ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo assert calibration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_frame2ttl&#39;</span><span class="p">][</span><span class="s1">&#39;COM_F2TTL&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The value for device_frame2ttl:COM_F2TTL in &#39;</span>
                <span class="s1">&#39;settings/hardware_settings.yaml is null. Please &#39;</span>
                <span class="s1">&#39;provide a valid port name.&#39;</span>
            <span class="p">)</span>
        <span class="n">Frame2TTL</span><span class="p">(</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_frame2ttl&#39;</span><span class="p">][</span><span class="s1">&#39;COM_F2TTL&#39;</span><span class="p">],</span>
            <span class="n">threshold_dark</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_frame2ttl&#39;</span><span class="p">][</span><span class="s1">&#39;F2TTL_DARK_THRESH&#39;</span><span class="p">],</span>
            <span class="n">threshold_light</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_frame2ttl&#39;</span><span class="p">][</span><span class="s1">&#39;F2TTL_LIGHT_THRESH&#39;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Frame2TTL: Thresholds set.&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RotaryEncoderMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.RotaryEncoderMixin.html#iblrig.base_tasks.RotaryEncoderMixin">[docs]</a>
<span class="k">class</span> <span class="nc">RotaryEncoderMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">,</span> <span class="n">HasBpod</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotary encoder interface for state machine.&quot;&quot;&quot;</span>

    <span class="n">device_rotary_encoder</span><span class="p">:</span> <span class="n">RotaryEncoderModule</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stimulus_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">STIM_GAIN</span>

<div class="viewcode-block" id="RotaryEncoderMixin.init_mixin_rotary_encoder">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.RotaryEncoderMixin.html#iblrig.base_tasks.RotaryEncoderMixin.init_mixin_rotary_encoder">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_rotary_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thresholds_deg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">STIM_POSITIONS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">QUIESCENCE_THRESHOLDS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_rotary_encoder</span> <span class="o">=</span> <span class="n">RotaryEncoderModule</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="p">,</span> <span class="n">thresholds_deg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_gain</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RotaryEncoderMixin.start_mixin_rotary_encoder">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.RotaryEncoderMixin.html#iblrig.base_tasks.RotaryEncoderMixin.start_mixin_rotary_encoder">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_rotary_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_gain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="o">.</span><span class="n">write_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_rotary_encoder</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Rotary Encoder Module loaded: OK&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ValveMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.ValveMixin.html#iblrig.base_tasks.ValveMixin">[docs]</a>
<span class="k">class</span> <span class="nc">ValveMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">,</span> <span class="n">HasBpod</span><span class="p">):</span>
<div class="viewcode-block" id="ValveMixin.init_mixin_valve">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.ValveMixin.html#iblrig.base_tasks.ValveMixin.init_mixin_valve">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valve</span> <span class="o">=</span> <span class="n">Valve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_valve</span><span class="p">)</span></div>


<div class="viewcode-block" id="ValveMixin.start_mixin_valve">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.ValveMixin.html#iblrig.base_tasks.ValveMixin.start_mixin_valve">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># assert that valve has been calibrated</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">valve</span><span class="o">.</span><span class="n">is_calibrated</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;VALVE IS NOT CALIBRATED - PLEASE CALIBRATE THE VALVE&quot;&quot;&quot;</span>

        <span class="c1"># regardless of the calibration method, the reward valve time has to be lower than 1 second</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reward_time</span><span class="p">(</span><span class="n">amount_ul</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;VALVE IS NOT PROPERLY CALIBRATED - PLEASE RECALIBRATE&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Water valve module loaded: OK&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ValveMixin.compute_reward_time">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.ValveMixin.html#iblrig.base_tasks.ValveMixin.compute_reward_time">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_reward_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_ul</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the valve opening time from a given volume.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        amount_ul : float, optional</span>
<span class="sd">            The volume of liquid (Œºl) to be dispensed from the valve. Defaults to task_params.REWARD_AMOUNT_UL.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Valve opening time in seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amount_ul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">REWARD_AMOUNT_UL</span> <span class="k">if</span> <span class="n">amount_ul</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">amount_ul</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valve</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ul2ms</span><span class="p">(</span><span class="n">amount_ul</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span></div>


<div class="viewcode-block" id="ValveMixin.valve_open">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.ValveMixin.html#iblrig.base_tasks.ValveMixin.valve_open">[docs]</a>
    <span class="k">def</span> <span class="nf">valve_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reward_valve_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the reward valve for a given amount of time and return bpod data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reward_valve_time : float</span>
<span class="sd">            Amount of time in seconds to open the reward valve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="p">)</span>
        <span class="n">sma</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span>
            <span class="n">state_name</span><span class="o">=</span><span class="s1">&#39;valve_open&#39;</span><span class="p">,</span>
            <span class="n">state_timer</span><span class="o">=</span><span class="n">reward_valve_time</span><span class="p">,</span>
            <span class="n">output_actions</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Valve1&#39;</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BNC1&#39;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)],</span>  <span class="c1"># To FPGA</span>
            <span class="n">state_change_conditions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Tup&#39;</span><span class="p">:</span> <span class="s1">&#39;exit&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">send_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">run_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>  <span class="c1"># Locks until state machine &#39;exit&#39; is reached</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">current_trial</span><span class="o">.</span><span class="n">export</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="SoundMixin">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SoundMixin.html#iblrig.base_tasks.SoundMixin">[docs]</a>
<span class="k">class</span> <span class="nc">SoundMixin</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">,</span> <span class="n">HasBpod</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sound interface methods for state machine.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SoundMixin.init_mixin_sound">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SoundMixin.html#iblrig.base_tasks.SoundMixin.init_mixin_sound">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_sound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;GO_TONE&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;WHITE_NOISE&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">sound_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span>

        <span class="c1"># additional gain factor for bringing the different combinations of sound-cards and amps to the same output level</span>
        <span class="c1"># TODO: this needs proper calibration and refactoring</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="o">.</span><span class="n">OUTPUT</span> <span class="o">==</span> <span class="s1">&#39;hifi&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="o">.</span><span class="n">AMP_TYPE</span> <span class="o">==</span> <span class="s1">&#39;AMP2X15&#39;</span><span class="p">:</span>
            <span class="n">amp_gain_factor</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amp_gain_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_AMPLITUDE</span> <span class="o">*=</span> <span class="n">amp_gain_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_AMPLITUDE</span> <span class="o">*=</span> <span class="n">amp_gain_factor</span>

        <span class="c1"># sound device sd is actually the module soundevice imported above.</span>
        <span class="c1"># not sure how this plays out when referenced outside of this python file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sound_device_factory</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">sound_output</span><span class="p">)</span>
        <span class="c1"># Create sounds and output actions of state machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;GO_TONE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">make_sound</span><span class="p">(</span>
            <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">],</span>
            <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_FREQUENCY</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_DURATION</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_AMPLITUDE</span> <span class="o">*</span> <span class="n">amp_gain_factor</span><span class="p">,</span>
            <span class="n">fade</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">chans</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;WHITE_NOISE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">make_sound</span><span class="p">(</span>
            <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">],</span>
            <span class="n">frequency</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_DURATION</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_AMPLITUDE</span> <span class="o">*</span> <span class="n">amp_gain_factor</span><span class="p">,</span>
            <span class="n">fade</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">chans</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">],</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SoundMixin.start_mixin_sound">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SoundMixin.html#iblrig.base_tasks.SoundMixin.start_mixin_sound">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_sound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depends on bpod mixin start for hard sound card</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">is_connected</span><span class="p">,</span> <span class="s1">&#39;The sound mixin depends on the bpod mixin being connected&#39;</span>
        <span class="c1"># SoundCard config params</span>
        <span class="k">match</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]:</span>
            <span class="k">case</span> <span class="s1">&#39;harp&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">sound_card</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;No harp sound-card connected to Bpod&#39;</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">configure_sound_card</span><span class="p">(</span>
                    <span class="n">sounds</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">GO_TONE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">WHITE_NOISE</span><span class="p">],</span>
                    <span class="n">indexes</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_IDX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_IDX</span><span class="p">],</span>
                    <span class="n">sample_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">define_harp_sounds_actions</span><span class="p">(</span>
                    <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">sound_card</span><span class="p">,</span>
                    <span class="n">go_tone_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_IDX</span><span class="p">,</span>
                    <span class="n">noise_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_IDX</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="s1">&#39;hifi&#39;</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">get_module</span><span class="p">(</span><span class="s1">&#39;^HiFi&#39;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;No HiFi module connected to Bpod&#39;</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="o">.</span><span class="n">COM_SOUND</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">hifi</span> <span class="o">=</span> <span class="n">HiFi</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="o">.</span><span class="n">COM_SOUND</span><span class="p">,</span> <span class="n">sampling_rate_hz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">])</span>
                <span class="n">hifi</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_IDX</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">GO_TONE</span><span class="p">)</span>
                <span class="n">hifi</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_IDX</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">WHITE_NOISE</span><span class="p">)</span>
                <span class="n">hifi</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
                <span class="n">hifi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">define_harp_sounds_actions</span><span class="p">(</span>
                    <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
                    <span class="n">go_tone_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">GO_TONE_IDX</span><span class="p">,</span>
                    <span class="n">noise_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_params</span><span class="o">.</span><span class="n">WHITE_NOISE_IDX</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">define_xonar_sounds_actions</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sound module loaded: OK: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_sound</span><span class="p">[</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SoundMixin.sound_play_noise">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SoundMixin.html#iblrig.base_tasks.SoundMixin.sound_play_noise">[docs]</a>
    <span class="k">def</span> <span class="nf">sound_play_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_timer</span><span class="o">=</span><span class="mf">0.510</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="s1">&#39;play_noise&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play the noise sound for the error feedback using bpod state machine.</span>
<span class="sd">        :return: bpod current trial export</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sound_play</span><span class="p">(</span><span class="n">state_name</span><span class="o">=</span><span class="n">state_name</span><span class="p">,</span> <span class="n">output_actions</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">play_tone</span><span class="p">],</span> <span class="n">state_timer</span><span class="o">=</span><span class="n">state_timer</span><span class="p">)</span></div>


<div class="viewcode-block" id="SoundMixin.sound_play_tone">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SoundMixin.html#iblrig.base_tasks.SoundMixin.sound_play_tone">[docs]</a>
    <span class="k">def</span> <span class="nf">sound_play_tone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_timer</span><span class="o">=</span><span class="mf">0.102</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="s1">&#39;play_tone&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play the ready tone beep using bpod state machine.</span>
<span class="sd">        :return: bpod current trial export</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sound_play</span><span class="p">(</span><span class="n">state_name</span><span class="o">=</span><span class="n">state_name</span><span class="p">,</span> <span class="n">output_actions</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">play_tone</span><span class="p">],</span> <span class="n">state_timer</span><span class="o">=</span><span class="n">state_timer</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_sound_play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_timer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="s1">&#39;play_sound&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plays a sound using bpod state machine.</span>

<span class="sd">        The sound must be defined in the init_mixin_sound method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">state_timer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;state_timer must be defined&#39;</span>
        <span class="k">assert</span> <span class="n">output_actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;output_actions must be defined&#39;</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="p">)</span>
        <span class="n">sma</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span>
            <span class="n">state_name</span><span class="o">=</span><span class="n">state_name</span><span class="p">,</span>
            <span class="n">state_timer</span><span class="o">=</span><span class="n">state_timer</span><span class="p">,</span>
            <span class="n">output_actions</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">play_tone</span><span class="p">],</span>
            <span class="n">state_change_conditions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;BNC2Low&#39;</span><span class="p">:</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;Tup&#39;</span><span class="p">:</span> <span class="s1">&#39;exit&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">send_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">run_state_machine</span><span class="p">(</span><span class="n">sma</span><span class="p">)</span>  <span class="c1"># Locks until state machine &#39;exit&#39; is reached</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpod</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">current_trial</span><span class="o">.</span><span class="n">export</span><span class="p">()</span></div>



<div class="viewcode-block" id="NetworkSession">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession">[docs]</a>
<span class="k">class</span> <span class="nc">NetworkSession</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A mixin for communicating to auxiliary acquisition PC over a network.&quot;&quot;&quot;</span>

    <span class="n">remote_rigs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;net.Auxiliaries: An auxiliary services object for communicating with remote devices.&quot;&quot;&quot;</span>
    <span class="n">exp_ref</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dict: The experiment reference (i.e. subject, date, sequence) as returned by main remote service.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NetworkSession.__init__">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">remote_rigs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A mixin for communicating to auxiliary acquisition PC over a network.</span>

<span class="sd">        This should retrieve the services list, i.e. the list of available auxiliary rigs,</span>
<span class="sd">        and determine which is the main sync. The main sync is the rig that determines the</span>
<span class="sd">        experiment.</span>

<span class="sd">        The services list is in a yaml file somewhere, called &#39;remote_rigs.yaml&#39; and should</span>
<span class="sd">        be a map of device name to URI. These are then selectable in the GUI and the URI of</span>
<span class="sd">        those selected are added to the experiment description.</span>

<span class="sd">        Subclasses should add their callbacks within init by calling :meth:`self.remote_rigs.services.assign_callback`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote_rigs : list, dict</span>
<span class="sd">            Either a list of remote device names (in which case URI is looked up from remote devices</span>
<span class="sd">            file), or a map of device name to URI.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional args such as &#39;file_iblrig_settings&#39; for defining location of remote data folder</span>
<span class="sd">            when loading remote devices file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remote_rigs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># For now we flatten to list of remote rig names but could permit list of (name, URI) tuples</span>
            <span class="n">remote_rigs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flatten</span><span class="p">(</span><span class="n">remote_rigs</span><span class="p">)))</span>
            <span class="n">all_remote_rigs</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">get_remote_devices</span><span class="p">(</span><span class="n">iblrig_settings</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iblrig_settings&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">remote_rigs</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">all_remote_rigs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Selected remote rigs not in remote rigs list&#39;</span><span class="p">)</span>
            <span class="n">remote_rigs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_remote_rigs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">remote_rigs</span><span class="p">}</span>
        <span class="c1"># Load and connect to remote services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">remote_rigs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_mixin_network</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ex</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ONE instance.</span>

<span class="sd">        Unlike super class getter, this method will always instantiate ONE, allowing subclasses to update with an Alyx</span>
<span class="sd">        token from a remotely connected rig.  This instance is used for formatting the experiment reference string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        one.api.One</span>
<span class="sd">            An instance of ONE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">one</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_one</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_one</span>

<div class="viewcode-block" id="NetworkSession.connect">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.connect">[docs]</a>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_rigs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to remote services.</span>

<span class="sd">        Instantiates the Communicator objects that establish connections with each remote device.</span>
<span class="sd">        This also creates the thread that uses asynchronous callbacks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote_rigs : dict</span>
<span class="sd">            A map of name to URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">Auxiliaries</span><span class="p">(</span><span class="n">remote_rigs</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">remote_rigs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span>
        <span class="c1"># Handle termination event by graciously completing thread</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_mixin_network</span><span class="p">())</span></div>


    <span class="k">def</span> <span class="nf">_init_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine session paths.</span>

<span class="sd">        Unlike :meth:`BaseSession._init_paths`, this method determines the session number from the remote main sync if</span>
<span class="sd">        connected.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        append : bool</span>
<span class="sd">            Iterate task collection within today&#39;s most recent session folder for the selected subject, instead of</span>
<span class="sd">            iterating session number.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        iblutil.util.Bunch</span>
<span class="sd">            A bunch of paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">MAIN_SYNC</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BaseSession</span><span class="o">.</span><span class="n">_init_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">)</span>
        <span class="c1"># Check if we have rigs connected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No remote rigs; experiment reference may not match the main sync.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">BaseSession</span><span class="o">.</span><span class="n">_init_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append</span><span class="p">)</span>
        <span class="c1"># Set paths in a similar way to the super class</span>
        <span class="n">rig_computer_paths</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">path_helper</span><span class="o">.</span><span class="n">get_local_and_remote_paths</span><span class="p">(</span>
            <span class="n">local_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;iblrig_local_data_path&#39;</span><span class="p">],</span>
            <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;iblrig_remote_data_path&#39;</span><span class="p">],</span>
            <span class="n">lab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_LAB&#39;</span><span class="p">],</span>
            <span class="n">iblrig_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;IBLRIG_FOLDER&#39;</span><span class="p">:</span> <span class="n">BASE_PATH</span><span class="p">})</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">BONSAI</span> <span class="o">=</span> <span class="n">BONSAI_EXE</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">VISUAL_STIM_FOLDER</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">IBLRIG_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;visual_stim&#39;</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">LOCAL_SUBJECT_FOLDER</span> <span class="o">=</span> <span class="n">rig_computer_paths</span><span class="p">[</span><span class="s1">&#39;local_subjects_folder&#39;</span><span class="p">]</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">REMOTE_SUBJECT_FOLDER</span> <span class="o">=</span> <span class="n">rig_computer_paths</span><span class="p">[</span><span class="s1">&#39;remote_subjects_folder&#39;</span><span class="p">]</span>
        <span class="n">date_folder</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">LOCAL_SUBJECT_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SUBJECT_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SESSION_START_TIME</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span> <span class="o">=</span> <span class="n">date_folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">03</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span> <span class="o">=</span> <span class="n">iblrig</span><span class="o">.</span><span class="n">path_helper</span><span class="o">.</span><span class="n">iterate_collection</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span> <span class="o">==</span> <span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Append value incorrect. Either remove previous task collections from &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="si">}</span><span class="s1">, or select append in GUI (--append arg in cli)&#39;</span>
            <span class="p">)</span>

        <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">TASK_COLLECTION</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">DATA_FILE_PATH</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskData.raw.jsonable&#39;</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">SETTINGS_FILE_PATH</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">SESSION_RAW_DATA_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskSettings.raw.json&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="o">.</span><span class="n">SESSION_NUMBER</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span>

<div class="viewcode-block" id="NetworkSession.run">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run session and report exceptions to remote services.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_mixin_network</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Communicate error to services</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span>  <span class="c1"># TODO maybe go one level down with tb_next?</span>
                <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>  <span class="c1"># exception name str</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>  <span class="c1"># error str</span>
                    <span class="s1">&#39;traceback&#39;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>  <span class="c1"># stack str</span>
                    <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span>  <span class="c1"># filename str</span>
                    <span class="s1">&#39;line_no&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">tb_lineno</span><span class="p">,</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_lasti</span><span class="p">),</span>  <span class="c1"># (int, int)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">ExpMessage</span><span class="o">.</span><span class="n">EXPINTERRUPT</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_mixin_network</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="NetworkSession.communicate">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.communicate">[docs]</a>
    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">raise_on_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Communicate message to remote services.</span>

<span class="sd">        This method is blocking and by default will raise if not all responses received in time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : iblutil.io.net.base.ExpMessage, str, int</span>
<span class="sd">            An experiment message to send to remote services.</span>
<span class="sd">        args</span>
<span class="sd">            One or more optional variables to send.</span>
<span class="sd">        raise_on_exception : bool</span>
<span class="sd">            If true, exceptions arising from message timeouts will be re-raised in main thread and</span>
<span class="sd">            services will be cleaned up. Only applies when wait is true.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Exception | dict</span>
<span class="sd">            If raise_on_exception is False, returns an exception if failed to receive all responses</span>
<span class="sd">            in time, otherwise a map of service name to response is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error on </span><span class="si">%s</span><span class="s1"> network mixin: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_on_exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_mixin_network</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="NetworkSession.get_exp_info">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.get_exp_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_exp_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dict2ref</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">is_main_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIN_SYNC&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">ExpInfo</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">is_main_sync</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_description</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">is_main_sync</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="NetworkSession.init_mixin_network">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.init_mixin_network">[docs]</a>
    <span class="k">def</span> <span class="nf">init_mixin_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize remote services.</span>

<span class="sd">        This method sends an EXPINFO message to all services, expecting exactly one of the responses</span>
<span class="sd">        to contain main_sync: True, along with the experiment reference to use. It then sends an</span>
<span class="sd">        EXPINIT message to all services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Determine experiment reference from main sync</span>
        <span class="n">is_main_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIN_SYNC&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_main_sync</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span>

        <span class="n">expinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exp_info</span><span class="p">()</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">]}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s1">&#39;EXPINFO&#39;</span><span class="p">,</span> <span class="s1">&#39;CONNECTED&#39;</span><span class="p">,</span> <span class="n">expinfo</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;main_sync&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;one main sync expected&#39;</span>
        <span class="n">main_rig_name</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;main_sync&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">ref2dict</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;exp_ref&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;exp_ref&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;exp_ref&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Running task for &quot;</span><span class="si">%s</span><span class="s1">&quot; but main sync returned exp ref for &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;SUBJECT_NAME&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subject name doesn&#39;t match remote session on &quot;</span> <span class="o">+</span> <span class="n">main_rig_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;SESSION_START_TIME&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Session dates do not match between this rig and </span><span class="si">{</span><span class="n">main_rig_name</span><span class="si">}</span><span class="s1">. </span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Running past or future sessions not currently supported. </span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Please check the system date time settings on each rig.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># exp_ref = ConversionMixin.path2ref(self.paths[&#39;SESSION_FOLDER&#39;], as_dict=False)</span>
        <span class="n">exp_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dict2ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s1">&#39;EXPINIT&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;exp_ref&#39;</span><span class="p">:</span> <span class="n">exp_ref</span><span class="p">})</span></div>


<div class="viewcode-block" id="NetworkSession.start_mixin_network">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.start_mixin_network">[docs]</a>
    <span class="k">def</span> <span class="nf">start_mixin_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start remote services.</span>

<span class="sd">        This method sends an EXPSTART message to all services, along with an exp_ref string.</span>
<span class="sd">        Responses are required but ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s1">&#39;EXPSTART&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ref</span><span class="p">)</span></div>


<div class="viewcode-block" id="NetworkSession.stop_mixin_network">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.stop_mixin_network">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_mixin_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start remote services.</span>

<span class="sd">        This method sends an EXPEND message to all services. Responses are required but ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s1">&#39;EXPEND&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NetworkSession.cleanup_mixin_network">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.NetworkSession.html#iblrig.base_tasks.NetworkSession.cleanup_mixin_network">[docs]</a>
    <span class="k">def</span> <span class="nf">cleanup_mixin_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up services.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_rigs</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to properly clean up network mixin&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SpontaneousSession">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SpontaneousSession.html#iblrig.base_tasks.SpontaneousSession">[docs]</a>
<span class="k">class</span> <span class="nc">SpontaneousSession</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Spontaneous task doesn&#39;t have trials, it just runs until the user stops it.</span>

<span class="sd">    It is used to get extraction structure for data streams</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SpontaneousSession.__init__">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SpontaneousSession.html#iblrig.base_tasks.SpontaneousSession.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_secs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration_secs</span> <span class="o">=</span> <span class="n">duration_secs</span></div>


<div class="viewcode-block" id="SpontaneousSession.start_hardware">
<a class="viewcode-back" href="../../api/iblrig.base_tasks.SpontaneousSession.html#iblrig.base_tasks.SpontaneousSession.start_hardware">[docs]</a>
    <span class="k">def</span> <span class="nf">start_hardware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># no mixin here, life is but a dream</span></div>


    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the task with the actual state machine.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting spontaneous acquisition&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_secs</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">SESSION_FOLDER</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">break</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018 ‚Äì 2024 International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>