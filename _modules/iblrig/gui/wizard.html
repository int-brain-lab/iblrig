

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iblrig.gui.wizard &mdash; iblrig 8.24.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_lesson.css?v=0c089442" />
      <link rel="stylesheet" type="text/css" href="../../../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=43b36fd3"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/minipres.js?v=a0d29692"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            iblrig
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Using IBLRIG v8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware.html">Hardware Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference_developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/int-brain-lab/iblrig">IBLRIG on GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://doi.org/10.6084/m9.figshare.11634732">Appendix 3: IBL protocol for setting up the behavioral training rig</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">iblrig</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">iblrig.gui.wizard</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iblrig.gui.wizard</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">importlib.util</span> <span class="kn">import</span> <span class="n">module_from_spec</span><span class="p">,</span> <span class="n">spec_from_file_location</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtWidgets</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QThreadPool</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QStyle</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">serial</span> <span class="kn">import</span> <span class="n">SerialException</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">override</span>

<span class="kn">import</span> <span class="nn">iblrig.hardware_validation</span>
<span class="kn">import</span> <span class="nn">iblrig.path_helper</span>
<span class="kn">import</span> <span class="nn">iblrig_tasks</span>
<span class="kn">from</span> <span class="nn">ibllib.io.raw_data_loaders</span> <span class="kn">import</span> <span class="n">load_settings</span>
<span class="kn">from</span> <span class="nn">iblrig.base_tasks</span> <span class="kn">import</span> <span class="n">BaseSession</span><span class="p">,</span> <span class="n">EmptySession</span>
<span class="kn">from</span> <span class="nn">iblrig.choiceworld</span> <span class="kn">import</span> <span class="n">compute_adaptive_reward_volume</span><span class="p">,</span> <span class="n">get_subject_training_info</span><span class="p">,</span> <span class="n">training_phase_from_contrast_set</span>
<span class="kn">from</span> <span class="nn">iblrig.constants</span> <span class="kn">import</span> <span class="n">BASE_DIR</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.frame2ttl</span> <span class="kn">import</span> <span class="n">Frame2TTLCalibrationDialog</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.splash</span> <span class="kn">import</span> <span class="n">Splash</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.tab_about</span> <span class="kn">import</span> <span class="n">TabAbout</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.tab_data</span> <span class="kn">import</span> <span class="n">TabData</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.tab_docs</span> <span class="kn">import</span> <span class="n">TabDocs</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.tab_log</span> <span class="kn">import</span> <span class="n">TabLog</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.tools</span> <span class="kn">import</span> <span class="n">DiskSpaceIndicator</span><span class="p">,</span> <span class="n">RemoteDevicesItemModel</span><span class="p">,</span> <span class="n">Worker</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.ui_login</span> <span class="kn">import</span> <span class="n">Ui_login</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.ui_update</span> <span class="kn">import</span> <span class="n">Ui_update</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.ui_wizard</span> <span class="kn">import</span> <span class="n">Ui_wizard</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.validation</span> <span class="kn">import</span> <span class="n">SystemValidationDialog</span>
<span class="kn">from</span> <span class="nn">iblrig.gui.valve</span> <span class="kn">import</span> <span class="n">ValveCalibrationDialog</span>
<span class="kn">from</span> <span class="nn">iblrig.hardware</span> <span class="kn">import</span> <span class="n">Bpod</span>
<span class="kn">from</span> <span class="nn">iblrig.hardware_validation</span> <span class="kn">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">iblrig.misc</span> <span class="kn">import</span> <span class="n">get_task_argument_parser</span>
<span class="kn">from</span> <span class="nn">iblrig.path_helper</span> <span class="kn">import</span> <span class="n">load_pydantic_yaml</span>
<span class="kn">from</span> <span class="nn">iblrig.pydantic_definitions</span> <span class="kn">import</span> <span class="n">HardwareSettings</span><span class="p">,</span> <span class="n">RigSettings</span>
<span class="kn">from</span> <span class="nn">iblrig.raw_data_loaders</span> <span class="kn">import</span> <span class="n">load_task_jsonable</span>
<span class="kn">from</span> <span class="nn">iblrig.tools</span> <span class="kn">import</span> <span class="n">alyx_reachable</span><span class="p">,</span> <span class="n">get_lab_location_dict</span><span class="p">,</span> <span class="n">internet_available</span>
<span class="kn">from</span> <span class="nn">iblrig.valve</span> <span class="kn">import</span> <span class="n">Valve</span>
<span class="kn">from</span> <span class="nn">iblrig.version_management</span> <span class="kn">import</span> <span class="n">check_for_updates</span><span class="p">,</span> <span class="n">get_changelog</span>
<span class="kn">from</span> <span class="nn">iblutil.util</span> <span class="kn">import</span> <span class="n">Bunch</span><span class="p">,</span> <span class="n">setup_logger</span>
<span class="kn">from</span> <span class="nn">one.webclient</span> <span class="kn">import</span> <span class="n">AlyxClient</span>
<span class="kn">from</span> <span class="nn">pybpodapi.exceptions.bpod_error</span> <span class="kn">import</span> <span class="n">BpodErrorException</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">iblrig_custom_tasks</span>

    <span class="n">CUSTOM_TASKS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">CUSTOM_TASKS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">pass</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOption</span><span class="p">(</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOptions</span><span class="p">(</span><span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">PROCEDURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Behavior training/tasks&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ephys recording with acute probe(s)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Ephys recording with chronic probe(s)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Fiber photometry&#39;</span><span class="p">,</span>
    <span class="s1">&#39;handling_habituation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Imaging&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">PROJECTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ibl_neuropixel_brainwide_01&#39;</span><span class="p">,</span> <span class="s1">&#39;practice&#39;</span><span class="p">]</span>

<span class="n">ANSI_COLORS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;31&#39;</span><span class="p">:</span> <span class="s1">&#39;Red&#39;</span><span class="p">,</span> <span class="s1">&#39;32&#39;</span><span class="p">:</span> <span class="s1">&#39;Green&#39;</span><span class="p">,</span> <span class="s1">&#39;33&#39;</span><span class="p">:</span> <span class="s1">&#39;Yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;35&#39;</span><span class="p">:</span> <span class="s1">&#39;Magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;36&#39;</span><span class="p">:</span> <span class="s1">&#39;Cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;37&#39;</span><span class="p">:</span> <span class="s1">&#39;White&#39;</span><span class="p">}</span>
<span class="n">REGEX_STDOUT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;^\x1b\[(?:\d;)?(?:\d+;)?&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;color&gt;\d+)m[\d-]*\s+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;time&gt;[\d\:]+)\s+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;level&gt;\w+\s+)&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;file&gt;[\w\:\.]+)\s+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;message&gt;[^\x1b]*)&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_set_list_view_from_string_list</span><span class="p">(</span><span class="n">ui_list</span><span class="p">:</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QListView</span><span class="p">,</span> <span class="n">string_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Small boiler plate util to set the selection of a list view from a list of strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ui_list</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">stringList</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">string_list</span><span class="p">:</span>
            <span class="n">ui_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ui_list</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">createIndex</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QItemSelectionModel</span><span class="o">.</span><span class="n">Select</span><span class="p">)</span>


<div class="viewcode-block" id="RigWizardModel">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RigWizardModel</span><span class="p">:</span>
    <span class="n">alyx</span><span class="p">:</span> <span class="n">AlyxClient</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">procedures</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">projects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session_folder</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test_subject_name</span> <span class="o">=</span> <span class="s1">&#39;test_subject&#39;</span>
    <span class="n">free_reward_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_iblrig_settings</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_hardware_settings</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">:</span> <span class="n">RigSettings</span> <span class="o">=</span> <span class="n">load_pydantic_yaml</span><span class="p">(</span><span class="n">RigSettings</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_iblrig_settings</span><span class="p">,</span> <span class="n">do_raise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">:</span> <span class="n">HardwareSettings</span> <span class="o">=</span> <span class="n">load_pydantic_yaml</span><span class="p">(</span>
            <span class="n">HardwareSettings</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_hardware_settings</span><span class="p">,</span> <span class="n">do_raise</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_reward_time</span> <span class="o">=</span> <span class="n">Valve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_valve</span><span class="p">)</span><span class="o">.</span><span class="n">free_reward_time_sec</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_URL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span> <span class="o">=</span> <span class="n">AlyxClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">),</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_users</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_USER&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_USER&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_procedures</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">PROCEDURES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_projects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">PROJECTS</span><span class="p">)</span>

        <span class="c1"># for the tasks, we build a dictionary that contains the task name as key and the path to task.py as value</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">iblrig_tasks</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;task.py&#39;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">CUSTOM_TASKS</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">iblrig_custom_tasks</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;task.py&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">})</span>

        <span class="c1"># get the subjects from iterating over folders in the the iblrig data path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;iblrig_local_data_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_subjects</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder_subjects</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;iblrig_local_data_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_LAB&#39;</span><span class="p">],</span> <span class="s1">&#39;Subjects&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_subjects</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder_subjects</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">]</span>
            <span class="p">)</span>

<div class="viewcode-block" id="RigWizardModel.get_session">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.get_session">[docs]</a>
    <span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseSession</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a session object for the given task name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task_name: str</span>
<span class="sd">            The name of the task</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BaseSession</span>
<span class="sd">            The session object for the given task name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">spec_from_file_location</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">[</span><span class="n">task_name</span><span class="p">])</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">Session</span></div>


<div class="viewcode-block" id="RigWizardModel.get_task_extra_parser">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.get_task_extra_parser">[docs]</a>
    <span class="k">def</span> <span class="nf">get_task_extra_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an extra parser for the given task name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task_name</span>
<span class="sd">            The name of the task</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ArgumentParser</span>
<span class="sd">            The extra parser for the given task name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span><span class="o">.</span><span class="n">extra_parser</span><span class="p">()</span></div>


<div class="viewcode-block" id="RigWizardModel.get_task_parameters">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.get_task_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_task_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bunch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return parameters for the given task.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task_name</span>
<span class="sd">            The name of the task</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Bunch</span>
<span class="sd">            The parameters for the given task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span><span class="o">.</span><span class="n">read_task_parameter_files</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="RigWizardModel.login">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.login">[docs]</a>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">do_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">alyx_client</span><span class="p">:</span> <span class="n">AlyxClient</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gui</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Use predefined AlyxClient for testing purposes:</span>
        <span class="k">if</span> <span class="n">alyx_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span> <span class="o">=</span> <span class="n">alyx_client</span>

        <span class="c1"># Alternatively, try to log in:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">do_cache</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Logged into </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1"> as </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="mi">400</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;credentials&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">)):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># validate connection and some parameters now that we&#39;re connected</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span>
                <span class="s1">&#39;locations&#39;</span><span class="p">,</span>
                <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">RIG_NAME</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="n">get_lab_location_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">)},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="mi">400</span><span class="p">):</span>  <span class="c1"># file not found; auth error</span>
                <span class="c1"># Likely Alyx is down or server-side issue</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to determine lab location on Alyx&#39;</span>
                <span class="n">solution</span> <span class="o">=</span> <span class="s1">&#39;Check if Alyx is reachable&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Could not find rig name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">RIG_NAME</span><span class="si">}</span><span class="s1"> in Alyx&#39;</span>
                <span class="n">solution</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Please check the RIG_NAME key in hardware_settings.yaml and make sure it is created in Alyx here: &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="si">}</span><span class="s1">/admin/misc/lablocation/&#39;</span>
                <span class="p">)</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">solution</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># get subjects from Alyx: this is the set of subjects that are alive and not stock in the lab defined in settings</span>
        <span class="n">rest_subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span>
            <span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">alive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_LAB&#39;</span><span class="p">],</span> <span class="n">no_cache</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_subjects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_subjects</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_subjects</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;nickname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rest_subjects</span><span class="p">]))</span>

        <span class="c1"># then get the projects that map to the current user</span>
        <span class="n">rest_projects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;projects&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">no_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rest_projects</span> <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_projects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">projects</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_projects</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="RigWizardModel.logout">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.logout">[docs]</a>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;User </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s1"> logged out&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>


<div class="viewcode-block" id="RigWizardModel.free_reward">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizardModel.html#iblrig.gui.wizard.RigWizardModel.free_reward">[docs]</a>
    <span class="k">def</span> <span class="nf">free_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">],</span> <span class="n">skip_initialization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable_behavior_ports</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">bpod</span><span class="o">.</span><span class="n">pulse_valve</span><span class="p">(</span><span class="n">open_time_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_reward_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">BpodErrorException</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot find bpod - is it connected?&#39;</span><span class="p">)</span>
            <span class="k">return</span></div>
</div>



<div class="viewcode-block" id="RigWizard">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard">[docs]</a>
<span class="k">class</span> <span class="nc">RigWizard</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMainWindow</span><span class="p">,</span> <span class="n">Ui_wizard</span><span class="p">):</span>
    <span class="n">training_info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">session_info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">task_parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">new_subject_details</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">append_session</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">previous_subject</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RigWizard.__init__">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">remote_devices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># load tabs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span> <span class="o">=</span> <span class="n">TabLog</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabData</span> <span class="o">=</span> <span class="n">TabData</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabDocs</span> <span class="o">=</span> <span class="n">TabDocs</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabAbout</span> <span class="o">=</span> <span class="n">TabAbout</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/log&#39;</span><span class="p">),</span> <span class="s1">&#39;Log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabData</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/sessions&#39;</span><span class="p">),</span> <span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabDocs</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/help&#39;</span><span class="p">),</span> <span class="s1">&#39;Docs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabAbout</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/about&#39;</span><span class="p">),</span> <span class="s1">&#39;About&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSettings</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RigWizardModel</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">yml</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;hardware_settings.yaml&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;hardware&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">title</span>
                <span class="k">else</span> <span class="s1">&#39;iblrig_settings.yaml&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;iblrig&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">title</span>
                <span class="k">else</span> <span class="s1">&#39;Settings File&#39;</span>
            <span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">():</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;table&gt;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tr&gt;&lt;td&gt;&lt;b&gt;key:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tr&gt;&lt;td&gt;&lt;b&gt;value:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;tr&gt;&lt;td&gt;&lt;b&gt;error:&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;br&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_error_dialog</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Error validating </span><span class="si">{</span><span class="n">yml</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># remote devices (only show if at least one device was found)</span>
        <span class="k">if</span> <span class="n">remote_devices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDevicesModel</span> <span class="o">=</span> <span class="n">RemoteDevicesItemModel</span><span class="p">(</span><span class="n">iblrig_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listViewRemoteDevices</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteDevicesModel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listViewRemoteDevices</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labelRemoteDevices</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># task parameters and subject details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_controls_for_task_arguments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_task_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subject_details</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_subject_details</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_automatic_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2view</span><span class="p">()</span>

        <span class="c1"># connect widgets signals to slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiActionValidateHardware</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_validate_hardware</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiActionCalibrateFrame2ttl</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_calibrate_frame2ttl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiActionCalibrateValve</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_calibrate_valve</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiActionTrainingLevelV7</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_menu_training_level_v7</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEditSubject</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_subjects</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_settings_widgets</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">installEventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaPlay</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaPause</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">controller2model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">currentChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_switch_tab</span><span class="p">)</span>

        <span class="c1"># username</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_URL</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">returnPressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_in_or_out</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushButtonLogIn</span><span class="o">.</span><span class="n">released</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_in_or_out</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushButtonLogIn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushReward</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">free_reward</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushReward</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Click to grant a free reward (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">device_valve</span><span class="o">.</span><span class="n">FREE_REWARD_VOLUME_UL</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> μL)&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;bpod_status_led&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="nb">bool</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_status_led</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_status_led</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>

        <span class="c1"># statusbar / disk stats</span>
        <span class="n">local_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;iblrig_local_data_path&#39;</span><span class="p">]</span>
        <span class="n">local_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">local_data</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;iblrig_data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiDiskSpaceIndicator</span> <span class="o">=</span> <span class="n">DiskSpaceIndicator</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusbar</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">local_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiDiskSpaceIndicator</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusbar</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiDiskSpaceIndicator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusbar</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># disable control of LED if Bpod does not have the respective capability</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">],</span> <span class="n">skip_initialization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">bpod</span><span class="o">.</span><span class="n">can_control_led</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SerialException</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># show splash-screen / store validation results</span>
        <span class="n">splash_screen</span> <span class="o">=</span> <span class="n">Splash</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">splash_screen</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_results</span> <span class="o">=</span> <span class="n">splash_screen</span><span class="o">.</span><span class="n">validation_results</span>

        <span class="c1"># check for update</span>
        <span class="n">update_worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">check_for_updates</span><span class="p">)</span>
        <span class="n">update_worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_check_update_result</span><span class="p">)</span>
        <span class="n">QThreadPool</span><span class="o">.</span><span class="n">globalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">update_worker</span><span class="p">)</span>

        <span class="c1"># show GUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowFlags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowFullscreenButtonHint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">(),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPoint</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># show validation errors / warnings:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">results</span> <span class="o">:=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Status</span><span class="o">.</span><span class="n">FAIL</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">WARN</span><span class="p">)]):</span>
            <span class="n">msg_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;IBLRIG System Validation&#39;</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setTextFormat</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">TextFormat</span><span class="o">.</span><span class="n">RichText</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The following issue</span><span class="si">{</span><span class="s1">&#39;s were&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39; was&#39;</span><span class="si">}</span><span class="s2"> detected:&quot;</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">text</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;&lt;br&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="s1">&#39;Warning&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Status</span><span class="o">.</span><span class="n">WARN</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Failure&#39;</span><span class="si">}</span><span class="s2">:&lt;/b&gt; </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;Suggestion:&lt;/b&gt; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">solution</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s1">&#39;&lt;br&gt;&lt;br&gt;</span><span class="se">\n</span><span class="s1">Please refer to the System Validation tool for more details.&#39;</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iblrig_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RigSettings</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">iblrig_settings</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hardware_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HardwareSettings</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hardware_settings</span>

    <span class="k">def</span> <span class="nf">_get_task_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">):</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_task_parameters</span><span class="p">,</span> <span class="n">task_name</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_task_parameters_result</span><span class="p">)</span>
        <span class="n">QThreadPool</span><span class="o">.</span><span class="n">globalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_task_parameters_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_parameters</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_subject_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_subject_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span>
            <span class="n">get_subject_training_info</span><span class="p">,</span>
            <span class="n">subject_name</span><span class="o">=</span><span class="n">subject_name</span><span class="p">,</span>
            <span class="n">task_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">currentText</span><span class="p">(),</span>
            <span class="n">stim_gain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AG_INIT_VALUE&#39;</span><span class="p">),</span>
            <span class="n">stim_gain_on_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STIM_GAIN&#39;</span><span class="p">),</span>
            <span class="n">default_reward</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REWARD_AMOUNT_UL&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_subject_details_result</span><span class="p">)</span>
        <span class="n">QThreadPool</span><span class="o">.</span><span class="n">globalInstance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_subject_details_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_subject_details</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_show_error_dialog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">issues</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suggestions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">leads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">build_list</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header_singular</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">header_plural</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">text</span>
            <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header_plural</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">header_plural</span> <span class="o">=</span> <span class="n">header_singular</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;</span><span class="si">{</span><span class="n">header_plural</span><span class="si">}</span><span class="s1">:&lt;ul&gt;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;</span><span class="si">{</span><span class="n">header_singular</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s1">:&lt;ul&gt;&#39;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;li&gt;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s1">&lt;/li&gt;&#39;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span>

        <span class="n">build_list</span><span class="p">(</span><span class="n">issues</span><span class="p">,</span> <span class="s1">&#39;Possible issue&#39;</span><span class="p">)</span>
        <span class="n">build_list</span><span class="p">(</span><span class="n">suggestions</span><span class="p">,</span> <span class="s1">&#39;Suggested action&#39;</span><span class="p">)</span>
        <span class="n">build_list</span><span class="p">(</span><span class="n">leads</span><span class="p">,</span> <span class="s1">&#39;Possible lead&#39;</span><span class="p">)</span>
        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_switch_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="c1"># if self.tabWidget.tabText(index) == &#39;Session&#39;:</span>
        <span class="c1"># QtCore.QTimer.singleShot(1, lambda: self.resize(self.minimumSizeHint()))</span>
        <span class="c1"># self.adjustSize()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_on_validate_hardware</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SystemValidationDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hardware_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">,</span> <span class="n">rig_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_calibrate_frame2ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Frame2TTLCalibrationDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hardware_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_calibrate_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ValveCalibrationDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_menu_training_level_v7</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prompt user for a session path to get v7 training level.</span>

<span class="sd">        This code will be removed and is here only for convenience while users transition from v7 to v8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get session path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">local_path</span> <span class="o">:=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\iblrig_data\Subjects&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">iblrig_local_data_path</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Select Session Path&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">ShowDirsOnly</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">session_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">session_path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># get trials table</span>
        <span class="n">file_jsonable</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;raw_behavior_data/_iblrig_taskData.raw.jsonable&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_jsonable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No jsonable found in </span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">trials_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_task_jsonable</span><span class="p">(</span><span class="n">file_jsonable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trials_table</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No trials found in </span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># get task settings</span>
        <span class="n">task_settings</span> <span class="o">=</span> <span class="n">load_settings</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">task_collection</span><span class="o">=</span><span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No task settings found in </span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># compute values</span>
        <span class="n">contrast_set</span> <span class="o">=</span> <span class="n">trials_table</span><span class="p">[</span><span class="s1">&#39;signed_contrast&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">training_phase</span> <span class="o">=</span> <span class="n">training_phase_from_contrast_set</span><span class="p">(</span><span class="n">contrast_set</span><span class="p">)</span>
        <span class="n">previous_reward_volume</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">task_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ADAPTIVE_REWARD_AMOUNT_UL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">task_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REWARD_AMOUNT_UL&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">task_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REWARD_AMOUNT&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">reward_amount</span> <span class="o">=</span> <span class="n">compute_adaptive_reward_volume</span><span class="p">(</span>
            <span class="n">subject_weight_g</span><span class="o">=</span><span class="n">task_settings</span><span class="p">[</span><span class="s1">&#39;SUBJECT_WEIGHT&#39;</span><span class="p">],</span>
            <span class="n">reward_volume_ul</span><span class="o">=</span><span class="n">previous_reward_volume</span><span class="p">,</span>
            <span class="n">delivered_volume_ul</span><span class="o">=</span><span class="n">trials_table</span><span class="p">[</span><span class="s1">&#39;reward_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="n">ntrials</span><span class="o">=</span><span class="n">trials_table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">stim_gain</span> <span class="o">=</span> <span class="n">trials_table</span><span class="p">[</span><span class="s1">&#39;stim_gain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># display results</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Information</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Training Level&#39;</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">session_path</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;training phase:</span><span class="se">\t</span><span class="si">{</span><span class="n">training_phase</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;reward:</span><span class="se">\t</span><span class="si">{</span><span class="n">reward_amount</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> uL</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;stimulus gain:</span><span class="se">\t</span><span class="si">{</span><span class="n">stim_gain</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;_iblrig_tasks_trainingChoiceWorld&#39;</span><span class="p">:</span>
            <span class="n">box</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Apply</span> <span class="o">|</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
        <span class="n">box</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">clickedButton</span><span class="p">()</span> <span class="o">==</span> <span class="n">box</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Apply</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">,</span> <span class="s1">&#39;--adaptive_gain&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">stim_gain</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">,</span> <span class="s1">&#39;--adaptive_reward&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">reward_amount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">,</span> <span class="s1">&#39;--training_phase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">training_phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_check_update_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the result of checking for updates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        result : tuple[bool, str | None]</span>
<span class="sd">            A tuple containing a boolean flag indicating update availability (result[0])</span>
<span class="sd">            and the remote version string (result[1]).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">UpdateNotice</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_log_in_or_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Routine for logging out:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushButtonLogIn</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Log Out&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">actions</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">removeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">actions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushButtonLogIn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Log In&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Routine for logging in:</span>
        <span class="c1"># 1) Try to log in with just the username. This will succeed if the credentials for the respective user are cached. We</span>
        <span class="c1">#    also try to catch connection issues and show helpful error messages.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logged_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">internet_available</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_error_dialog</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Error connecting to Alyx&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Your computer appears to be offline.&#39;</span><span class="p">,</span>
                    <span class="n">suggestions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Check your internet connection.&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">alyx_reachable</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_error_dialog</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Error connecting to Alyx&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cannot connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">leads</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;Is `ALYX_URL` in `iblrig_settings.yaml` set correctly?&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Is your machine allowed to connect to Alyx?&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Is the Alyx server up and running nominally?&#39;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 2) If there is no cached session for the given user and we can connect to Alyx: show the password dialog and loop</span>
        <span class="c1">#    until, either, the login was successful or the cancel button was pressed.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logged_in</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">remember</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">logged_in</span><span class="p">:</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">LoginWindow</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">remember</span><span class="o">=</span><span class="n">remember</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
                    <span class="n">username</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">lineEditUsername</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                    <span class="n">remember</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">checkBoxRememberMe</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                    <span class="n">logged_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">do_cache</span><span class="o">=</span><span class="n">remember</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                    <span class="k">break</span>

        <span class="c1"># 3) Finally, if the login was successful, we need to apply some changes to the GUI</span>
        <span class="k">if</span> <span class="n">logged_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/check&#39;</span><span class="p">),</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="o">.</span><span class="n">ActionPosition</span><span class="o">.</span><span class="n">TrailingPosition</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiLineEditUser</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;background-color: rgb(246, 245, 244);&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushButtonLogIn</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Log Out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model2view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">logged_in</span>

<div class="viewcode-block" id="RigWizard.eventFilter">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.eventFilter">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">eventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">HoverEnter</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">HoverLeave</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">widget</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">match</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>
                    <span class="k">case</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">HoverEnter</span><span class="p">:</span>
                        <span class="n">widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;QListView { background-color: pink; border: 1px solid red; }&#39;</span><span class="p">)</span>
                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                        <span class="n">widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RigWizard.closeEvent">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.closeEvent">[docs]</a>
    <span class="nd">@override</span>
    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">accept</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;bpod_status_led&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_status_led</span><span class="p">(</span><span class="n">is_toggled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">])</span>  <span class="c1"># bpod is a singleton</span>
            <span class="n">bpod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Hold on&#39;</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;A task is running - do you really want to quit?&#39;</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span> <span class="o">|</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">Question</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">msg_box</span><span class="o">.</span><span class="n">exec_</span><span class="p">():</span>
                <span class="k">case</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span>
                <span class="k">case</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_stop</span><span class="p">()</span>
                    <span class="n">accept</span><span class="p">()</span></div>


<div class="viewcode-block" id="RigWizard.model2view">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.model2view">[docs]</a>
    <span class="k">def</span> <span class="nf">model2view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># stores the current values in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller2model</span><span class="p">()</span>
        <span class="c1"># set the default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QStringListModel</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QStringListModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_subjects</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QStringListModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_procedures</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QStringListModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_projects</span><span class="p">))</span>
        <span class="c1"># set the selections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="n">_set_list_view_from_string_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">procedures</span><span class="p">)</span>
        <span class="n">_set_list_view_from_string_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">projects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span></div>


<div class="viewcode-block" id="RigWizard.controller2model">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.controller2model">[docs]</a>
    <span class="k">def</span> <span class="nf">controller2model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">procedures</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">data</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiComboTask</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_controls_for_task_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller2model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># collect &amp; filter list of parser arguments (general &amp; task specific)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_task_argument_parser</span><span class="p">()</span><span class="o">.</span><span class="n">_actions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_task_extra_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span><span class="p">)</span><span class="o">.</span><span class="n">_actions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">option_strings</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;--subject&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--user&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--projects&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--log-level&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--procedures&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--weight&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--help&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--append&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--no-interactive&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--stub&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--wizard&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;--remote&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_settings_widgets</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">layout</span><span class="o">.</span><span class="n">rowCount</span><span class="p">():</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">option_strings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

            <span class="c1"># create widget for bool arguments</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_StoreTrueAction</span> <span class="o">|</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_StoreFalseAction</span><span class="p">):</span>
                <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">()</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">setTristate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># create widget for string arguments</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># string options (-&gt; combo-box)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QComboBox</span><span class="p">()</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                        <span class="n">widget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">([</span><span class="n">widget</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">count</span><span class="p">())]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>

                <span class="c1"># list of strings (-&gt; line-edit)</span>
                <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">nargs</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                        <span class="n">widget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">widget</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
                    <span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

                <span class="c1"># single string (-&gt; line-edit)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                        <span class="n">widget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">widget</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

            <span class="c1"># create widget for list of floats</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">nargs</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">widget</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
                <span class="p">)</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

            <span class="c1"># create widget for adaptive gain</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">dest</span> <span class="o">==</span> <span class="s1">&#39;adaptive_gain&#39;</span><span class="p">:</span>
                <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># create widget for numerical arguments</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">param</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>

            <span class="c1"># no other argument types supported for now</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># add custom widget properties</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s1">&#39;parameter_name&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s1">&#39;parameter_dest&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>

            <span class="c1"># display help strings as status tip</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">help</span><span class="p">)</span>

            <span class="c1"># some customizations</span>
            <span class="k">match</span> <span class="n">widget</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="s1">&#39;parameter_dest&#39;</span><span class="p">):</span>
                <span class="k">case</span> <span class="s1">&#39;probability_left&#39;</span> <span class="o">|</span> <span class="s1">&#39;probability_opto_stim&#39;</span><span class="p">:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">case</span> <span class="s1">&#39;contrast_set_probability_type&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Probability Type&#39;</span>

                <span class="k">case</span> <span class="s1">&#39;session_template_id&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Session Template ID&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

                <span class="k">case</span> <span class="s1">&#39;delay_secs&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Initial Delay, s&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">86400</span><span class="p">)</span>

                <span class="k">case</span> <span class="s1">&#39;training_phase&#39;</span><span class="p">:</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s1">&#39;automatic&#39;</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">case</span> <span class="s1">&#39;adaptive_reward&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Reward Amount, μl&#39;</span>
                    <span class="n">minimum</span> <span class="o">=</span> <span class="mf">1.4</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s1">&#39;automatic&#39;</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="n">minimum</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">minimum</span><span class="p">())</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">minimum</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">m</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>

                <span class="k">case</span> <span class="s1">&#39;reward_set_ul&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Reward Set, μl&#39;</span>

                <span class="k">case</span> <span class="s1">&#39;adaptive_gain&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Stimulus Gain&#39;</span>
                    <span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="s1">&#39;automatic&#39;</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="n">minimum</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">minimum</span><span class="p">())</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">arg</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">minimum</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_task_arg</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">m</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>

                <span class="k">case</span> <span class="s1">&#39;reward_amount_ul&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Reward Amount, μl&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">case</span> <span class="s1">&#39;stim_gain&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Stimulus Gain&#39;</span>

                <span class="k">case</span> <span class="s1">&#39;stim_reverse&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Reverse Stimulus&#39;</span>

                <span class="k">case</span> <span class="s1">&#39;duration_spontaneous&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Spontaneous Activity, s&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

            <span class="n">widget</span><span class="o">.</span><span class="n">wheelEvent</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">event</span><span class="p">:</span> <span class="kc">None</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="n">widget</span><span class="p">)</span>

        <span class="c1"># add label to indicate absence of task specific parameters</span>
        <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s1">&#39;(none)&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_automatic_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_helper</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">str_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">widget</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">destination</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39; (default)&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;automatic</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39; (default)&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">setSpecialValueText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;automatic: </span><span class="si">{</span><span class="n">value</span><span class="si">:{</span><span class="n">str_format</span><span class="si">}}{</span><span class="n">default</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">_helper</span><span class="p">(</span><span class="s1">&#39;training_phase&#39;</span><span class="p">,</span> <span class="s1">&#39;--training_phase&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">_helper</span><span class="p">(</span><span class="s1">&#39;adaptive_reward&#39;</span><span class="p">,</span> <span class="s1">&#39;--adaptive_reward&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1f&#39;</span><span class="p">)</span>
        <span class="n">_helper</span><span class="p">(</span><span class="s1">&#39;adaptive_gain&#39;</span><span class="p">,</span> <span class="s1">&#39;--adaptive_gain&#39;</span><span class="p">,</span> <span class="s1">&#39;0.1f&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_task_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_arguments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_filter_subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filter_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineEditSubject</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">all_subjects</span> <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">test_subject_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiComboSubject</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QStringListModel</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

<div class="viewcode-block" id="RigWizard.pause">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.pause">[docs]</a>
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;QPushButton {background-color: yellow;}&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">match</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="k">case</span> <span class="kc">True</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pausing after current trial ...&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.pause&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming ...&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.pause&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.pause&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="RigWizard.start_stop">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.start_stop">[docs]</a>
    <span class="k">def</span> <span class="nf">start_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">match</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">text</span><span class="p">():</span>
            <span class="k">case</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Stop&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaStop</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span>

                <span class="c1"># Manage appended session</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_session</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_subject</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hardware_settings</span><span class="o">.</span><span class="n">MAIN_SYNC</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">append_session</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="s1">&#39;Appended Session&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Would you like to append to the previous session?&#39;</span><span class="p">,</span>
                            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span>
                            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="o">==</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>
                    <span class="p">)</span>

                <span class="c1"># Manage subject weight</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="p">()</span>
                <span class="n">weight</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">getDouble</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;Subject Weight&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Subject Weight (g):&#39;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">flags</span><span class="o">=</span><span class="n">dlg</span><span class="o">.</span><span class="n">windowFlags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowContextHelpButtonHint</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaPlay</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">controller2model</span><span class="p">()</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">EmptySession</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">append_session</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;SESSION_FOLDER&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">raw_data_folder</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;SESSION_RAW_DATA_FOLDER&#39;</span><span class="p">]</span>

                <span class="c1"># disable Bpod status LED</span>
                <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">])</span>
                <span class="n">bpod</span><span class="o">.</span><span class="n">set_status_led</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># close Bpod singleton so subprocess can access use the port</span>
                <span class="n">bpod</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># build the argument list for the subprocess</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_file</span><span class="p">)])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">user</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--subject&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">procedures</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--procedures&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">procedures</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">projects</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--projects&#39;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">projects</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remotes</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listViewRemoteDevices</span><span class="o">.</span><span class="n">getDevices</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--remote&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">remotes</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_arguments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--weight&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--log-level&#39;</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="s1">&#39;INFO&#39;</span><span class="p">])</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--wizard&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_session</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;--append&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="o">.</span><span class="n">appendText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting subprocess: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span><span class="si">}</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;White&#39;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting subprocess&#39;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QProcess</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">setWorkingDirectory</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">setProcessChannelMode</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QProcess</span><span class="o">.</span><span class="n">SeparateChannels</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_task_finished</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">readyReadStandardOutput</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_read_standard_output</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">readyReadStandardError</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_read_standard_error</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">),</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span><span class="s1">&#39;stop the session after the current trial&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaStop</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="p">))</span>
            <span class="k">case</span> <span class="s1">&#39;Stop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.stop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_on_read_standard_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and process standard output entries.</span>

<span class="sd">        Reads standard output from a running task process, processes each entry,</span>
<span class="sd">        extracts color information, sets character color in the QPlainTextEdit widget,</span>
<span class="sd">        and appends time and message information to the widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">readAllStandardOutput</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">REGEX_STDOUT</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">ANSI_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;37&#39;</span><span class="p">),</span> <span class="s1">&#39;White&#39;</span><span class="p">)</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="o">.</span><span class="n">appendText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_read_standard_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and process standard error entries.</span>

<span class="sd">        Reads standard error from a running task process, sets character color</span>
<span class="sd">        in the QPlainTextEdit widget to indicate an error (Red), and appends</span>
<span class="sd">        the error message to the widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span><span class="o">.</span><span class="n">readAllStandardError</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="o">.</span><span class="n">appendText</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Red&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_task_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">exit_status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabLog</span><span class="o">.</span><span class="n">appendText</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Subprocess finished.&#39;</span><span class="p">,</span> <span class="s1">&#39;White&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exit_code</span><span class="p">:</span>
            <span class="n">msg_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Oh no!&#39;</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;The task was terminated with an error.</span><span class="se">\n</span><span class="s1">Please check the log for details.&#39;</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span><span class="o">.</span><span class="n">Critical</span><span class="p">)</span>
            <span class="n">msg_box</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running_task_process</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># re-enable UI elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setStatusTip</span><span class="p">(</span><span class="s1">&#39;start the session&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">()</span><span class="o">.</span><span class="n">standardIcon</span><span class="p">(</span><span class="n">QStyle</span><span class="o">.</span><span class="n">SP_MediaPlay</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span>

        <span class="c1"># recall state of Bpod status LED</span>
        <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">])</span>
        <span class="n">bpod</span><span class="o">.</span><span class="n">set_status_led</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">task_settings_file</span> <span class="o">:=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">raw_data_folder</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;_iblrig_taskSettings.raw.json&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task_settings_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">session_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>

            <span class="c1"># check if session was a dud</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">ntrials</span> <span class="o">:=</span> <span class="n">session_data</span><span class="p">[</span><span class="s1">&#39;NTRIALS&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">42</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">task_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;spontaneous&#39;</span><span class="p">,</span> <span class="s1">&#39;passive&#39;</span><span class="p">)])</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_session</span>
            <span class="p">):</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;Is this a dud?&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;The session consisted of only </span><span class="si">{</span><span class="n">ntrials</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> trial&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">ntrials</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> and appears to be a dud.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Should it be deleted?&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">session_folder</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">previous_subject</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">subject</span>

            <span class="c1"># manage poop count</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="p">()</span>
            <span class="n">droppings</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;Droppings&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Number of droppings:&#39;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">dlg</span><span class="o">.</span><span class="n">windowFlags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowContextHelpButtonHint</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">session_data</span><span class="p">[</span><span class="s1">&#39;POOP_COUNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">droppings</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task_settings_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">session_data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="RigWizard.flush">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># paint button blue when in toggled state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span>
            <span class="s1">&#39;QPushButton {background-color: rgb(128, 128, 255);}&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">],</span>
                <span class="n">skip_initialization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">disable_behavior_ports</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">bpod</span><span class="o">.</span><span class="n">open_valve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">isChecked</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">BpodErrorException</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot find bpod - is it connected?&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="RigWizard.toggle_status_led">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.RigWizard.html#iblrig.gui.wizard.RigWizard.toggle_status_led">[docs]</a>
    <span class="k">def</span> <span class="nf">toggle_status_led</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_toggled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># paint button green when in toggled state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;QPushButton {background-color: rgb(128, 255, 128);}&#39;</span> <span class="k">if</span> <span class="n">is_toggled</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_ui_elements</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bpod</span> <span class="o">=</span> <span class="n">Bpod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hardware_settings</span><span class="p">[</span><span class="s1">&#39;device_bpod&#39;</span><span class="p">][</span><span class="s1">&#39;COM_BPOD&#39;</span><span class="p">],</span> <span class="n">skip_initialization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bpod</span><span class="o">.</span><span class="n">set_status_led</span><span class="p">(</span><span class="n">is_toggled</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">BpodErrorException</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_enable_ui_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Stop&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStart</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiListProjects</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uiListProcedures</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushPause</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushFlush</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushReward</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiPushStatusLED</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupParameters</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTaskParameters</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiGroupTools</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_running</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span></div>



<div class="viewcode-block" id="LoginWindow">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.LoginWindow.html#iblrig.gui.wizard.LoginWindow">[docs]</a>
<span class="k">class</span> <span class="nc">LoginWindow</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">Ui_login</span><span class="p">):</span>
<div class="viewcode-block" id="LoginWindow.__init__">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.LoginWindow.html#iblrig.gui.wizard.LoginWindow.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">RigWizard</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">remember</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">setSizeConstraint</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLayout</span><span class="o">.</span><span class="n">SetFixedSize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelServer</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">iblrig_settings</span><span class="p">[</span><span class="s1">&#39;ALYX_URL&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEditUsername</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkBoxRememberMe</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">remember</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEditUsername</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_text_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_text_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span>
            <span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/hide&#39;</span><span class="p">),</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="o">.</span><span class="n">ActionPosition</span><span class="o">.</span><span class="n">TrailingPosition</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toggle_password_visibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_text_changed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_on_text_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">enable_ok</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineEditUsername</span><span class="o">.</span><span class="n">text</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">text</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enable_ok</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_toggle_password_visibility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/show&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">setEchoMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="o">.</span><span class="n">EchoMode</span><span class="o">.</span><span class="n">Normal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_password</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;:/images/hide&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineEditPassword</span><span class="o">.</span><span class="n">setEchoMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="o">.</span><span class="n">EchoMode</span><span class="o">.</span><span class="n">Password</span><span class="p">)</span></div>



<div class="viewcode-block" id="UpdateNotice">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.UpdateNotice.html#iblrig.gui.wizard.UpdateNotice">[docs]</a>
<span class="k">class</span> <span class="nc">UpdateNotice</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">Ui_update</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dialog for displaying update notices.</span>

<span class="sd">    This class is used to create a dialog for displaying update notices.</span>
<span class="sd">    It shows information about the available update and provides a changelog.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent : QtWidgets.QWidget</span>
<span class="sd">        The parent widget associated with this dialog.</span>

<span class="sd">    update_available : bool</span>
<span class="sd">        Indicates if an update is available.</span>

<span class="sd">    version : str</span>
<span class="sd">        The version of the available update.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UpdateNotice.__init__">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.UpdateNotice.html#iblrig.gui.wizard.UpdateNotice.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_DeleteOnClose</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiLabelHeader</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Update to iblrig </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1"> is available.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiTextBrowserChanges</span><span class="o">.</span><span class="n">setMarkdown</span><span class="p">(</span><span class="n">get_changelog</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windowFlags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowContextHelpButtonHint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../api/iblrig.gui.wizard.main.html#iblrig.gui.wizard.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;increase logging verbosity&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--remote_devices&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;remote_devices&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show controls for remote devices&#39;</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;iblrig&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
    <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">setOrganizationName</span><span class="p">(</span><span class="s1">&#39;International Brain Laboratory&#39;</span><span class="p">)</span>
    <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">setOrganizationDomain</span><span class="p">(</span><span class="s1">&#39;internationalbrainlab.org&#39;</span><span class="p">)</span>
    <span class="n">QtCore</span><span class="o">.</span><span class="n">QCoreApplication</span><span class="o">.</span><span class="n">setApplicationName</span><span class="p">(</span><span class="s1">&#39;IBLRIG Wizard&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;IBL.iblrig.wizard.</span><span class="si">{</span><span class="n">iblrig</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">shell32</span><span class="o">.</span><span class="n">SetCurrentProcessExplicitAppUserModelID</span><span class="p">(</span><span class="n">app_id</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-sandbox&#39;</span><span class="p">])</span>
    <span class="n">app</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="s1">&#39;Fusion&#39;</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">RigWizard</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">remote_devices</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">remote_devices</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018 – 2024 International Brain Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>